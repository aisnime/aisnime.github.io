<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AISNIME</title>
    
    <meta name="theme-color" content="#8B5CF6">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://i.imgur.com/7b4w4qH.png">
    
    <link rel="icon" id="favicon" href="https://aisnime.site/loading.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- [DIUBAH] Versi cache busting dinaikkan -->
    <link rel="stylesheet" href="styles.css?v=2.93"> 
</head>
<!-- [DIUBAH] h-screen, overflow-hidden, dan flex-col diterapkan di SEMUA ukuran -->
<!-- [DIUBAH] pb-[10vh] diubah menjadi pb-[5vh] untuk nav 5% -->
<body class="bg-gray-900 text-white h-screen overflow-hidden flex flex-col pb-[5vh] lg:pb-0" style="font-family: 'Inter', sans-serif;">
    
    <div id="loading-overlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-900">
        <img id="loading-favicon" src="https://aisnime.site/loading.ico" alt="Memuat..." class="w-16 h-16 rounded-lg animate-pulse">
        <p class="text-gray-400 mt-4">Memuat data...</p>
    </div>

    <!-- [DIUBAH] Konten utama sekarang menjadi flex-1 (mengisi sisa ruang) dan scrollable di mobile -->
    <!-- [DIUBAH] overflow-y-auto diubah menjadi overflow-y-hidden untuk menghentikan scroll utama di mobile -->
    <div id="main-content" class="overlay hidden flex-1 min-h-0 overflow-y-hidden lg:overflow-y-visible lg:flex lg:flex-col">
        <!-- [DIHAPUS] Notifikasi Link Disalin -->

        <!-- [DIUBAH] Kontainer utama sekarang adalah flex, bukan grid. Padding di sini. -->
        <!-- [DIUBAH] Menambahkan pt-4 (padding atas) untuk mobile -->
        <!-- [DIUBAH] Menambahkan flex, flex-col, dan h-full untuk MEMPERBAIKI SCROLLING di mobile -->
        <div class="container mx-auto flex flex-col h-full lg:flex-1 lg:flex lg:flex-row lg:gap-8 lg:min-h-0 lg:py-8 px-4 pt-4 lg:px-0">
            
            <!-- [DIUBAH] Header Atas (HANYA MOBILE) - DISIMPAN TAPI DISembunyikan -->
            <div class="lg:hidden relative p-4 h-16 flex items-center justify-between hidden">
                <!-- Tombol Buka Filter Genre Mobile -->
                <button id="open-genre-btn" class="p-2 text-white bg-gray-700 bg-opacity-50 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                </button>
                <!-- Tombol Buka Chat Mobile -->
                <button id="open-chat-btn" class="p-2 text-white bg-gray-700 bg-opacity-50 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 21l1.949-3.828a9.863 9.863 0 01-1.042-4.172C3.907 7.582 7.94 4 12 4c4.97 0 9 3.582 9 8z"></path></svg>
                </button>
            </div>

            <!-- [DIHAPUS] Logo & Search (HANYA MOBILE) - Dipindahkan ke sidebar -->
            
            <!-- [DIHAPUS] Wrapper grid kedua yang berlebihan telah dihapus -->
                
            <!-- [KOLOM 1] Sidebar Kiri Desktop (Sticky & Expanding) -->
            <!-- [DIUBAH] Menggunakan w-20, sticky, max-height, dan z-20 -->
            <aside id="desktop-sidebar" class="hidden lg:block lg:w-20 lg:flex-shrink-0 lg:sticky lg:top-8 z-20" style="max-height: calc(100vh - 4rem);">
                <!-- [DIUBAH] 'overflow-y-auto' DIHAPUS untuk memperbaiki bug fly-out -->
                <div class="bg-gray-800 bg-opacity-70 rounded-lg p-4 flex flex-col h-full overflow-x-visible">
                    
                    <!-- [DIUBAH] Wrapper untuk konten atas sidebar -->
                    <div class="space-y-6">
                        <!-- Kontainer Navigasi Dinamis (Sekarang 'relative group') -->
                        <div id="dynamic-nav-links" class="space-y-2">
                            <!-- Link dari admin akan dimuat oleh JS di sini -->
                            <p class="text-sm text-gray-400">Memuat navigasi...</p>
                        </div>

                        <!-- [DIUBAH] Kontainer Filter Genre (Dengan Tooltip Fly-out) -->
                        <div id="genre-filter-desktop" class="pt-4 border-t border-gray-700 relative group">
                            <!-- [DIUBAH] Judul dihapus dari sini, hanya ikon sebagai trigger -->
                            <div class="cursor-pointer flex justify-center items-center p-2 rounded-lg hover:bg-gray-700">
                                <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                            </div>
                            
                            <!-- [DIUBAH] Panel Fly-out (z-50, w-max, dan "jembatan" padding) -->
                            <div id="genre-flyout-panel" 
                                 class="hidden group-hover:block absolute left-0 top-0 z-50 pt-2"
                                 style="padding-left: 5rem;"> <!-- 5rem = w-20, ini adalah "jembatan" transparan -->
                                
                                <!-- Konten panel yang terlihat -->
                                <div class="w-max p-4 bg-gray-700 rounded-lg shadow-xl" style="max-height: 400px; overflow-y: auto;">
                                    <!-- [BARU] Judul di dalam panel -->
                                    <h3 class="text-white text-lg font-semibold mb-2">Filter Genre</h3>
                                    <!-- [DIUBAH] flex-col dan space-y-1 untuk daftar vertikal -->
                                    <div id="genre-list-desktop" class="flex flex-col space-y-1">
                                        <!-- Genre buttons will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- [BARU] Spacer untuk mendorong tombol laporan ke bawah -->
                    <div class="flex-grow"></div>

                    <!-- [DIUBAH] Kontainer Laporan (mt-auto DIHAPUS, sekarang didorong oleh spacer) -->
                    <div id="report-button-desktop-container" class="pt-4 border-t border-gray-700">
                         <!-- [DIUBAH] Tombol sekarang menjadi 'relative group' untuk tooltipnya sendiri -->
                         <button id="open-report-btn-desktop" class="relative group w-full flex items-center justify-center text-sm text-gray-400 hover:text-white hover:bg-gray-700 p-2 rounded-lg transition-colors">
                            <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2zm0 0h18"></path></svg>
                            <!-- [BARU] Tooltip -->
                            <span class="absolute left-full top-1/2 -translate-y-1/2 ml-3 px-3 py-1 bg-gray-900 shadow-lg rounded-md text-sm text-white hidden lg:group-hover:block whitespace-nowrap z-20">
                                Laporkan Masalah
                            </span>
                        </button>
                    </div>
                </div>
            </aside>

            <!-- [KOLOM 2] Konten Tengah (Scrollable) -->
            <!-- [DIUBAH] 'main-content-container', 'p-6', 'lg:overflow-y-auto' dipindahkan ke <main> -->
            <!-- [KOMENTAR BARU] Ini adalah Baris 1 (Konten 80%) di tampilan mobile -->
            <!-- [DIUBAH] Struktur <main> diubah untuk menerapkan scroll HANYA pada daftar konten -->
            <main class="main-content-container p-6 flex flex-col flex-1 min-h-0 lg:flex-1 lg:flex lg:flex-col lg:min-w-0 relative z-10 lg:overflow-y-auto">
                
                <!-- [DIHAPUS] Poster Header telah dihapus -->
                
                <!-- [DIHAPUS] Filter Genre Desktop dipindahkan ke sidebar -->
                
                <!-- Judul "UPDATE TERBARU" dipindahkan ke sini agar tetap diam -->
                <h2 class="text-3xl font-bold mb-6">UPDATE TERBARU</h2>
                
                <!-- Kontainer ini akan mengisi sisa ruang -->
                <div id="content-rows-container" class="space-y-8 flex flex-col flex-1 min-h-0">
                    <!-- Baris "Update Terbaru" diubah menjadi area scroll -->
                    <div id="latest-updates-row" class="flex-1 overflow-y-auto">
                        <!-- #content-list sekarang menjadi pembungkus grid di dalam area scroll -->
                        <div id="content-list">
                            <p id="no-content-message" class="text-gray-500 col-span-full text-center py-8">Memuat konten...</p>
                        </div>
                    </div>
                    <!-- Baris kustom lainnya (jika ada) akan dimuat oleh JS di sini, 
                         NAMUN di tata letak mobile ini, baris tersebut mungkin tidak akan terlihat 
                         karena #latest-updates-row mengambil semua sisa ruang. -->
                </div>
            </main>
            <!-- [KOMENTAR BARU] Akhir dari Baris 1 (Konten) -->


            <!-- [KOLOM 3] Sidebar Kanan (Sticky) -->
            <!-- [DIUBAH] Menggunakan lg:w-80, lg:bg-transparent, dan z-20 -->
            <aside id="info-chat-sidebar" class="fixed top-0 right-0 h-full w-80 bg-gray-800 shadow-xl z-50 transform translate-x-full transition-transform duration-300 
                                            lg:block lg:relative lg:translate-x-0 lg:z-auto lg:w-80 lg:flex-shrink-0 lg:sticky lg:top-8 lg:bg-transparent z-20" 
                 style="max-height: calc(100vh - 4rem);">
                
                <!-- Wrapper untuk Logo, Search, dan Chat -->
                <div class="flex flex-col h-full">
                
                    <!-- [DIPINDAHKAN] Logo & Search Desktop (Tanpa Background) -->
                    <div class="hidden lg:block p-4 flex-shrink-0">
                        <header class="text-center lg:text-right mb-4 lg:mb-0 relative">
                            <img id="main-logo" src="" alt="Logo Aplikasi" class="w-auto h-10 mx-auto lg:ml-auto lg:mx-0 mb-4 hidden">
                            <h1 id="main-title-text" class="text-5xl lg:text-4xl font-extrabold text-white drop-shadow-lg"></h1>
                        </header>
                        <form id="search-form" class="w-full max-w-xl mx-auto lg:ml-auto lg:mr-0 mt-4 mb-8">
                            <!-- [DIUBAH] border, border-gray-600, dan bg-opacity-50 dihapus -->
                            <input type="search" id="search-input" placeholder="Cari berdasarkan judul atau genre..." class="w-full bg-gray-700 rounded-full py-3 px-6 text-white focus:ring-2 focus:ring-purple-500 transition">
                        </form>
                    </div>
                    
                    <!-- [DIUBAH] Chat Wrapper (Sekarang bisa scroll) -->
                    <div id="chat-container" class="rounded-lg flex flex-col flex-1 min-h-0"> 
                        <!-- Header Chat -->
                        <div class="flex justify-between items-center p-4 border-b border-gray-700 flex-shrink-0 bg-gray-800 rounded-t-lg">
                            <h3 class="font-bold text-white">Chat Publik</h3>
                            <button id="close-chat-btn" class="text-gray-400 hover:text-white text-2xl lg:hidden">&times;</button>
                        </div>
                        
                        <!-- [DIUBAH] Area Pesan (flex-grow dan bg-gray-800) -->
                        <div id="chat-messages" class="flex-grow p-4 space-y-3 overflow-y-auto bg-gray-800">
                            <p class="text-xs text-gray-500 text-center">Menyambungkan ke chat...</p>
                        </div>
                        
                        <!-- [DIUBAH] Input Pesan (flex-shrink-0 dan bg-gray-800) -->
                        <div class="p-4 border-t border-gray-700 flex-shrink-0 bg-gray-800 rounded-b-lg">
                            <form id="chat-form" class="flex space-x-2">
                                <input type="text" id="chat-input" placeholder="Ketik pesan..." class="flex-1 bg-gray-700 rounded-full py-2 px-4 text-white focus:ring-2 focus:ring-purple-500" autocomplete="off">
                                <button type="submit" id="chat-send-btn" class="bg-purple-600 hover:bg-purple-700 rounded-full w-10 h-10 flex items-center justify-center flex-shrink-0">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 16.5V3.5a1 1 0 00.894-1.053l-1.48 8.88A1 1 0 0010.894 2.553z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Overlay Chat Mobile -->
    <div id="chat-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>
    
    <!-- Sidebar Genre Mobile -->
    <div id="genre-sidebar" class="fixed top-0 left-0 h-full w-72 bg-gray-800 shadow-xl z-50 transform -translate-x-full transition-transform duration-300 flex flex-col">
        <!-- Header -->
        <div class="flex justify-between items-center p-4 border-b border-gray-700 flex-shrink-0">
            <!-- [DIUBAH] Judul diubah -->
            <h3 class="font-bold text-white">Pencarian & Filter</h3>
            <button id="close-genre-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>

        <!-- [BARU] Logo & Search (Dipindahkan ke sini) -->
        <div class="p-4">
            <header class="text-center mb-4">
                <img id="main-logo-mobile" src="" alt="Logo Aplikasi" class="w-auto h-10 mx-auto mb-4 hidden">
                <h1 id="main-title-text-mobile" class="text-4xl font-extrabold text-white drop-shadow-lg"></h1>
            </header>
            <form id="search-form-mobile" class="w-full max-w-xl mx-auto">
                <input type="search" id="search-input-mobile" placeholder="Cari berdasarkan judul atau genre..." class="w-full bg-gray-700 bg-opacity-50 border border-gray-600 rounded-full py-3 px-6 text-white focus:ring-2 focus:ring-purple-500 transition">
            </form>
        </div>

        <!-- [DIUBAH] Daftar Genre Mobile (Horizontal & Scroll-X) -->
        <div id="genre-list-mobile" class="flex-shrink-0 p-4 flex flex-row space-x-2 overflow-x-auto border-t border-gray-700">
            <!-- Genre buttons will be loaded here -->
        </div>
        
        <!-- [BARU] Tombol Laporan dipindahkan ke sini -->
        <div class="p-4 border-t border-gray-700 flex-shrink-0">
            <button id="open-report-btn" class="w-full flex items-center justify-center text-sm text-gray-400 hover:text-white hover:bg-gray-700 p-2 rounded-lg transition-colors">
                <svg class="w-5 h-5" mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2zm0 0h18"></path></svg>
                <span>Laporkan Masalah</span>
            </button>
        </div>
    </div>
    <!-- Overlay Genre Mobile -->
    <div id="genre-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>


    <!-- Tampilan Maintenance (Awalnya disembunyikan) -->
    <div id="maintenance-overlay" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center text-center bg-gray-900 p-4">
        <img id="maintenance-logo" src="" alt="Logo" class="w-40 h-40 rounded-full mb-6 border-4 border-gray-700 shadow-lg">
        <h1 class="text-4xl font-bold text-white">MAINTENANCE</h1>
        <p class="text-gray-300 mt-2 max-w-md">Mohon Maaf, Kami sedang melakukan beberapa pembaruan</p>
    </div>

    <!-- [DIHAPUS] MODAL DAFTAR EPISODE (LAMA) -->

    <!-- [DIUBAH] MODAL VIDEO (SEKARANG MENJADI MODAL UTAMA) -->
    <!-- [DIUBAH] Mengembalikan items-center justify-center dan p-4 -->
    <div id="video-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50">
       <!-- [DIUBAH] Mengembalikan max-w-6xl, menghapus h-full -->
       <div class="bg-gray-900 rounded-lg shadow-2xl w-full max-w-6xl relative group flex flex-col">
            <!-- [DIUBAH] Tombol close dikembalikan ke posisi luar -->
            <button id="close-modal-btn" class="absolute -top-3 -right-3 bg-white text-black rounded-full w-8 h-8 flex items-center justify-center font-bold text-xl z-20">&times;</button>
            
            <!-- [DIUBAH] Baris Atas (lg:flex-1 dan lg:min-h-0 DIHAPUS, grid diubah ke 5 kolom) -->
            <div class="p-6 lg:grid lg:grid-cols-5 lg:gap-6">
                
                <!-- [BARU] Kolom 1: Thumbnail -->
                <!-- [DIUBAH] col-span-2 diubah menjadi col-span-1, h-full dihapus -->
                <div class="hidden lg:flex lg:col-span-1">
                    <img id="modal-thumbnail" src="" alt="Thumbnail Serial" class="w-full h-auto object-cover rounded-md border-2 border-gray-700">
                </div>

                <!-- [DIUBAH] Kolom 2: Video Player (col-span-3) -->
                <div class="lg:col-span-3">
                    <div id="video-container" class="w-full aspect-video bg-black rounded-lg relative group">
                        <img id="video-loading-icon" src="" alt="Memuat..." class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-16 h-16 animate-pulse hidden z-10">
                        <video id="modal-main-player" class="w-full h-full relative z-0" controls controlslist="nodownload" disablepictureinpicture playsinline autoplay></video>
                    </div>
                </div>

                <!-- [BARU] Kolom 3: Daftar Episode -->
                <!-- [DIUBAH] col-span-1 (dari 5), h-64 di mobile, h-96 di desktop, h-full dihapus -->
                <div class="lg:col-span-1 bg-gray-800 rounded-lg p-2 h-72 lg:h-96 overflow-y-auto mt-4 lg:mt-0 flex flex-col">
                    <div id="modal-episode-list-container" class="flex-1 overflow-y-auto">
                        <p class="text-xs text-gray-400 text-center">Memuat episode...</p>
                    </div>
                </div>
            </div>

            <!-- [BARU] Baris Bawah (Info Konten) -->
            <!-- [DIUBAH] Memperbaiki typo 'class.' menjadi 'class=' -->
            <div id="modal-content-info" class="p-6 pt-0 lg:pt-6 border-t border-gray-700 flex-shrink-0 overflow-y-auto">
                <h3 id="modal-content-title" class="text-2xl font-bold text-white mb-2">Memuat judul...</h3>
                <div class="flex flex-col items-start text-sm text-gray-400 gap-y-2">
                    <div class="flex flex-row flex-wrap items-center gap-x-4 gap-y-1">
                        <!-- Rating -->
                        <div class="flex items-center space-x-1 text-yellow-400 font-semibold">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                    <span id="modal-content-rating">N/A</span>
                                </div>
                                <!-- Vote -->
                                <div class="flex items-center space-x-1">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                                    <span id="modal-content-vote">N/A</span>
                                </div>
                                <!-- Total Episode -->
                                <div class="flex items-center space-x-1">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                                    <span id="modal-content-episodes">...</span>
                                </div>
                            </div>
                            <!-- Ikon MAL -->
                            <div>
                                <span class="p-1 bg-blue-800 text-white text-xs font-bold rounded">MAL</span>
                            </div>
<div id="modal-description-wrapper" class="h-24 overflow-y-auto mt-4">
                    <!-- [DIUBAH] Menambahkan 'break-words' untuk memaksa teks panjang agar patah (wrap) -->
                    <p id="modal-content-description" class="text-gray-400 text-sm whitespace-pre-wrap break-words">Tidak ada deskripsi.</p>
                </div>
                        </div>
                    </div>
                </div>
                <!-- [DIUBAH] Deskripsi sekarang dibungkus div dengan scroll -->
                
                
                <!-- [DIHAPUS] Tombol "Lihat Daftar Episode" tidak diperlukan lagi -->
            </div>
        </div>
    </div>
    
    <!-- [BARU] MODAL LAPORAN/KELUHAN -->
    <div id="report-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-lg flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-2xl font-bold">Kirim Laporan / Keluhan</h3>
                <button id="close-report-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <form id="report-form">
                    <p class="text-sm text-gray-300 mb-4">Mohon jelaskan masalah yang Anda temui. Laporan Anda akan dikirim secara anonim (menggunakan User ID Anda) untuk ditinjau oleh admin.</p>
                    <textarea id="report-textarea" rows="5" class="w-full bg-gray-700 rounded-md p-3 text-white" placeholder="Jelaskan masalah Anda di sini..." required></textarea>
                    <button type="submit" id="send-report-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-md mt-4 transition">
                        Kirim Laporan
                    </button>
                    <p id="report-status-message" class="text-center text-sm min-h-[20px] mt-2"></p>
                </form>
            </div>
        </div>
    </div>

    <!-- [BARU] Navigasi Bawah (Hanya Mobile) -->
    <!-- [KOMENTAR BARU] Ini adalah Baris 2 (Navigasi 10%) di tampilan mobile -->
    <!-- [DIUBAH] h-16 diubah menjadi h-[5vh] untuk nav 5% -->
    <nav id="mobile-bottom-nav" class="lg:hidden fixed bottom-0 left-0 right-0 h-[5vh] bg-gray-800 border-t border-gray-700 flex justify-around items-center z-40">
        <!-- Kiri: Genre / Pencarian -->
        <button id="bottom-nav-genre-btn" class="p-3 text-gray-400 hover:text-white">
            <!-- [DIUBAH] Ikon diubah menjadi ikon Pencarian -->
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </button>
        
        <!-- Tengah: Home (Favicon) -->
        <button id="bottom-nav-home-btn" class="p-2 rounded-full bg-purple-600 shadow-lg">
            <img id="bottom-nav-favicon" src="https://aisnime.site/loading.ico" alt="Home" class="w-8 h-8 rounded-full">
        </button>
        
        <!-- Kanan: Chat -->
        <button id="bottom-nav-chat-btn" class="p-3 text-gray-400 hover:text-white">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 21l1.949-3.828a9.863 9.863 0 01-1.042-4.172C3.907 7.582 7.94 4 12 4c4.97 0 9 3.582 9 8z"></path></svg>
        </button>
    </nav>
    
    <!-- [DIUBAH] SEMUA KODE JS DIKEMBALIKAN KE index.html -->
    <script type="module">
        /* --- [DIKEMBALIKAN] Firebase Config --- */
        const firebaseConfig = {
          apiKey: "AIzaSyBkSf56I0akk5poCZ5t8QI1MNlUvZ8Aiu0",
          authDomain: "aisnime.firebaseapp.com",
          projectId: "aisnime",
          storageBucket: "aisnime.firebasestorage.app",
          messagingSenderId: "736632750777",
          appId: "1:736632750777:web:8756d28d0ffe2698739168"
        };
        
        /* --- [DIKEMBALIKAN] Firebase Imports --- */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; 
        import { 
            getFirestore, collection, query, where, orderBy, onSnapshot, 
            doc, getDoc, getDocs, updateDoc, deleteDoc, setDoc, 
            Timestamp, increment, limit, addDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        /* --- [DIKEMBALIKAN] Firebase Init --- */
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        /* --- [DIKEMBALIKAN] Collection Refs --- */
        const seriesCollRef = collection(db, 'series'); 
        const settingsCollRef = collection(db, 'settings');
        const contentRowsCollRef = collection(db, 'contentRows'); 
        const reportsCollRef = collection(db, 'reports');
        const navLinksCollRef = collection(db, 'navigationLinks'); 
        
        /* --- [DIKEMBALIKAN] Variabel Global --- */
        let contentListEl, mainLogoImg, mainTitleText, contentRowsContainer; 
        let mainLogoUrl = ''; 
        let allSeriesContent = [];
        let filteredSeriesContent = []; 
        let isLoadingMore = false;
        let isSearching = false;
        let currentDisplayCount = 0;
        const MOBILE_LIMIT = 18; /* [DIUBAH] Diubah dari 6 menjadi 18 */
        const DESKTOP_LIMIT = 20; /* [DIUBAH] Diubah dari 10 menjadi 20 */
        let chatCollRef = null;
        let currentUserId = null;
        let chatUnsubscribe = null; 
        let blockedWordsList = [];
        let faviconUrl = '';
        let isWatchModuleLoaded = false;
        let genreSidebar, genreOverlay, openGenreBtn, closeGenreBtn, genreListMobile, genreListDesktop;
        let allGenres = new Set();
        let activeGenre = 'All';
        let videoModal, closeModalBtn, modalMainPlayer, videoContainer;
        let currentSeriesId = null;
        let currentItem = null;
        let saveTimeout;
        let watermarkEl = null; 
        
        /* --- [DIKEMBALIKAN] FUNGSI DARI function.js --- */
        
        function loadInitialContent() {
            const q = query(seriesCollRef, orderBy("updatedAt", "desc"), limit(DESKTOP_LIMIT * 2)); // Ambil 2 batch awal
            
            onSnapshot(q, (snapshot) => {
                allSeriesContent = snapshot.docs.map(doc => ({id: doc.id, data: doc.data()}));
                
                filteredSeriesContent = allSeriesContent;
                currentDisplayCount = 0;
                if(contentListEl) contentListEl.innerHTML = ''; 
                renderMoreContent(); 
                setupGenreFilter(); 

            }, (error) => {
                console.error(`Gagal memuat konten dari ${seriesCollRef.path}: ${error.message}`); 
                if (contentListEl) {
                    contentListEl.innerHTML = '<p class="text-red-500 col-span-full text-center py-8">Error memuat konten.</p>';
                }
            });
        }

        function renderCustomRow(title, seriesContent) {
            const rowEl = document.createElement('div');
            rowEl.className = 'custom-content-row'; 

            const gridEl = document.createElement('div');
            gridEl.className = 'grid grid-cols-1 sm:grid-cols-2 gap-6'; 

            let itemsRendered = 0;
            seriesContent.forEach(itemData => {
                const card = createSeriesCard(itemData);
                if (card) {
                    gridEl.appendChild(card);
                    itemsRendered++;
                }
            });

            if (itemsRendered > 0) { 
                 rowEl.innerHTML = `<h2 class="text-3xl font-bold mb-6">${title.toUpperCase()}</h2>`;
                 rowEl.appendChild(gridEl);
                 if (contentRowsContainer) contentRowsContainer.appendChild(rowEl);
            }
        }

        function createSeriesCard(itemData) {
            if (!itemData || !itemData.data || !itemData.data.thumbnailUrl || !itemData.data.title) {
                console.warn(`MELEWATI item, data tidak lengkap.`); 
                return null; 
            }

            const itemEl = document.createElement('div');
            itemEl.className = 'content-card bg-gray-800 bg-opacity-50 rounded-lg overflow-hidden shadow-lg transform transition-transform duration-200 hover:-translate-y-1 cursor-pointer';
            
            itemEl.innerHTML = `
                <div class="relative w-full aspect-[7/9] bg-black">
                    <img src="${itemData.data.thumbnailUrl}" alt="${itemData.data.title}" class="w-full h-full object-cover" loading="lazy">
                </div>
                <div class="p-4 space-y-1 text-left">
                    <h4 class="font-semibold text-white leading-tight truncate text-xs" title="${itemData.data.title}">${itemData.data.title}</h4>
                    <div class="flex items-center justify-between mt-1"> 
                        <div class="flex items-center text-[9px] text-yellow-400">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            <span>${(itemData.data.rating || 'N/A').replace(' / 10', '')}</span>
                        </div>
                        
                        <div class="flex items-center text-[9px] text-gray-400">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                            <span>${(itemData.data.episodeCount || 0)} Eps</span>
                        </div>
                        <div class="flex items-center text-[9px] text-gray-400">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            <span>${(itemData.data.viewCount || 0).toLocaleString('id-ID')}</span>
                        </div>
                    </div>
                </div>`;
            /* [DIUBAH] Event listener sekarang memanggil 'playLatestEpisode' */
            itemEl.addEventListener('click', () => {
                playLatestEpisode(itemData.id, itemData.data);
            });
            return itemEl;
        }

        function setupSearchListener() {
            
            const handleSearchInput = (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                
                const latestUpdatesRow = document.getElementById('latest-updates-row');
                const customRows = document.querySelectorAll('.custom-content-row');

                if (searchTerm.length > 0) {
                    isSearching = true;
                    customRows.forEach(row => row.classList.add('hidden'));
                    if (latestUpdatesRow) latestUpdatesRow.classList.remove('hidden'); 

                    filteredSeriesContent = allSeriesContent.filter(item => 
                        item.data.title.toLowerCase().includes(searchTerm) ||
                        (item.data.genre && (Array.isArray(item.data.genre) ? item.data.genre.join(', ') : item.data.genre).toLowerCase().includes(searchTerm))
                    );
                } else {
                    isSearching = false;
                    customRows.forEach(row => row.classList.remove('hidden'));
                    if (latestUpdatesRow) latestUpdatesRow.classList.remove('hidden');
                    
                    filterContent(activeGenre); 
                    return;
                }
                currentDisplayCount = 0;
                if (contentListEl) contentListEl.innerHTML = '';
                renderMoreContent(); 
            };

            const handleSearchSubmit = (e) => e.preventDefault();

            // Desktop
            const searchInputDesktop = document.getElementById('search-input');
            const searchFormDesktop = document.getElementById('search-form');
            if (searchInputDesktop) searchInputDesktop.addEventListener('input', handleSearchInput);
            if (searchFormDesktop) searchFormDesktop.addEventListener('submit', handleSearchSubmit);

            // Mobile
            const searchInputMobile = document.getElementById('search-input-mobile');
            const searchFormMobile = document.getElementById('search-form-mobile');
            if (searchInputMobile) searchInputMobile.addEventListener('input', handleSearchInput);
            if (searchFormMobile) searchFormMobile.addEventListener('submit', handleSearchSubmit);
        }

        function setupEventListeners(){
            /* [DIUBAH] Target scroll diperbaiki untuk mobile dan desktop */
            const mobileScrollEl = document.getElementById('main-content');
            if (mobileScrollEl) {
                mobileScrollEl.addEventListener('scroll', handleScroll); /* Listener untuk Mobile */
            }
            
            const desktopScrollEl = document.querySelector('main.main-content-container');
            if (desktopScrollEl) {
                desktopScrollEl.addEventListener('scroll', handleScroll); /* Listener untuk Desktop */
            }
            /* [DIHAPUS] Listener 'window' yang lama dihapus */
            
            const toggleGenreSidebar = (open) => {
                if (open) {
                    if (genreSidebar) genreSidebar.classList.remove('-translate-x-full');
                    if (genreOverlay) genreOverlay.classList.remove('hidden');
                } else {
                    if (genreSidebar) genreSidebar.classList.add('-translate-x-full');
                    if (genreOverlay) genreOverlay.classList.add('hidden');
                }
            };

            if (openGenreBtn) openGenreBtn.addEventListener('click', () => toggleGenreSidebar(true));
            if (closeGenreBtn) closeGenreBtn.addEventListener('click', () => toggleGenreSidebar(false));
            if (genreOverlay) genreOverlay.addEventListener('click', () => toggleGenreSidebar(false));
            
            const bottomNavGenreBtn = document.getElementById('bottom-nav-genre-btn');
            if (bottomNavGenreBtn) bottomNavGenreBtn.addEventListener('click', () => toggleGenreSidebar(true));

            const bottomNavHomeBtn = document.getElementById('bottom-nav-home-btn');
            if (bottomNavHomeBtn) bottomNavHomeBtn.addEventListener('click', () => { 
                window.scrollTo({ top: 0, behavior: 'smooth' }); 
            });


            document.body.addEventListener('contextmenu', (e) => {
                // e.preventDefault(); 
            });
        }
        
        function handleScroll(e) {
            /* [DIHAPUS] Pengecekan isSearching/activeGenre dihapus agar infinite scroll selalu aktif */
            if (isLoadingMore) return;
            
            /* [DIUBAH] Logika target disederhanakan untuk menangkap event dari listener yang benar */
            const target = e.target; 
            
            // Cek apakah kita sudah mendekati bagian bawah
            if (target.scrollHeight - target.scrollTop - target.clientHeight < 500) {
                 renderMoreContent();
            }
        }

        function renderMoreContent() {
            if (isLoadingMore) return;
            isLoadingMore = true;

            const dataToRender = (isSearching || activeGenre !== 'All') ? filteredSeriesContent : allSeriesContent;
            
            let itemsToLoad;
            /* [DIUBAH] Logika if/else dihapus agar selalu memuat per batch */
            
            // Logika infinite scroll normal (sekarang berlaku untuk semua mode)
            const limit = window.innerWidth < 768 ? MOBILE_LIMIT : DESKTOP_LIMIT;
            itemsToLoad = dataToRender.slice(currentDisplayCount, currentDisplayCount + limit);
            
            
            if (itemsToLoad.length === 0) {
                if (currentDisplayCount === 0 && contentListEl) {
                    contentListEl.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">Tidak ada konten ditemukan.</p>';
                }
                isLoadingMore = false;
                return;
            }
            
            if (currentDisplayCount === 0) {
                 const msgEl = document.getElementById('no-content-message');
                 if (msgEl) msgEl.remove();
            } 

            itemsToLoad.forEach(itemData => {
                const card = createSeriesCard(itemData);
                if (contentListEl && card) contentListEl.appendChild(card);
            });

            currentDisplayCount += itemsToLoad.length;
            isLoadingMore = false;
        }

        function setupGenreFilter() {
            allGenres = new Set();
            allSeriesContent.forEach(item => {
                if (!item.data.genre) return; 

                let genres = [];
                if (Array.isArray(item.data.genre)) {
                    genres = item.data.genre;
                } else if (typeof item.data.genre === 'string') {
                    genres = item.data.genre.split(',').map(g => g.trim()).filter(g => g);
                }

                genres.forEach(g => allGenres.add(g.trim()));
            });

            if (genreListMobile) genreListMobile.innerHTML = '';
            if (genreListDesktop) genreListDesktop.innerHTML = '';
            
            createGenreButton('All');
            if (allGenres.size > 0) {
                 Array.from(allGenres).sort().forEach(genre => {
                    createGenreButton(genre);
                });
            }
            
            updateActiveGenreButtons();
        }
        
        function createGenreButton(genre) {
            const button = document.createElement('button');
            button.textContent = genre;
            button.className = 'genre-btn text-xs font-medium py-1 px-3 rounded-full transition lg:w-full lg:text-left lg:rounded-md lg:px-3 lg:py-2 lg:bg-gray-600 lg:hover:bg-gray-500';
            button.dataset.genre = genre;
            
            button.addEventListener('click', () => filterContent(genre));
            
            if (genreListMobile) genreListMobile.appendChild(button.cloneNode(true));
            if (genreListDesktop) genreListDesktop.appendChild(button.cloneNode(true));
            
            if (genreListMobile && genreListMobile.lastChild) genreListMobile.lastChild.addEventListener('click', () => filterContent(genre));
            if (genreListDesktop && genreListDesktop.lastChild) genreListDesktop.lastChild.addEventListener('click', () => filterContent(genre));
        }
        
        function filterContent(genre) {
            activeGenre = genre;
            
            const searchInputDesktop = document.getElementById('search-input');
            const searchInputMobile = document.getElementById('search-input-mobile');
            if (searchInputDesktop && searchInputDesktop.value) searchInputDesktop.value = '';
            if (searchInputMobile && searchInputMobile.value) searchInputMobile.value = '';
            
            const latestUpdatesRow = document.getElementById('latest-updates-row');
            const customRows = document.querySelectorAll('.custom-content-row');
            
            if (genre === 'All') {
                isSearching = false;
                filteredSeriesContent = allSeriesContent;
                customRows.forEach(row => row.classList.remove('hidden')); 
                if (latestUpdatesRow) latestUpdatesRow.classList.remove('hidden');
            } else {
                isSearching = true; 
                customRows.forEach(row => row.classList.add('hidden')); 
                if (latestUpdatesRow) latestUpdatesRow.classList.remove('hidden'); 

                filteredSeriesContent = allSeriesContent.filter(item => {
                    if (!item.data.genre) return false;
                    if (Array.isArray(item.data.genre)) {
                        return item.data.genre.includes(genre);
                    }
                    if (typeof item.data.genre === 'string') {
                        return item.data.genre.split(',').map(g => g.trim()).includes(genre);
                    }
                    return false;
                });
            }
            
            if (genreSidebar) genreSidebar.classList.add('-translate-x-full');
            if (genreOverlay) genreOverlay.classList.add('hidden');
            
            currentDisplayCount = 0;
            if (contentListEl) contentListEl.innerHTML = '';
            renderMoreContent();
            updateActiveGenreButtons();
        }
        
        function updateActiveGenreButtons() {
            const allButtons = document.querySelectorAll('.genre-btn');
            allButtons.forEach(btn => {
                if (btn.dataset.genre === activeGenre) {
                    btn.classList.add('bg-purple-600', 'text-white');
                    btn.classList.remove('bg-gray-700', 'text-gray-300', 'lg:bg-gray-600');
                } else {
                    btn.classList.remove('bg-purple-600', 'text-white');
                    btn.classList.add('bg-gray-700', 'text-gray-300', 'lg:bg-gray-600');
                }
            });
        }

        function censorMessage(message, blocklist) {
            if (!blocklist || blocklist.length === 0) return message;
            
            let censoredText = message;
            blocklist.forEach(word => {
                const regex = new RegExp(word, 'gi'); 
                censoredText = censoredText.replace(regex, (match) => '*'.repeat(match.length));
            });
            return censoredText;
        }

        function setupChat() {
            chatCollRef = collection(db, 'chat');
            
            const chatContainer = document.getElementById('info-chat-sidebar');
            const chatOverlay = document.getElementById('chat-overlay');
            const openChatBtn = document.getElementById('open-chat-btn');
            const closeChatBtn = document.getElementById('close-chat-btn');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const chatMessagesEl = document.getElementById('chat-messages');

            const toggleChat = (open) => {
                if (open) {
                    if (chatContainer) chatContainer.classList.remove('translate-x-full');
                    if (chatOverlay) chatOverlay.classList.remove('hidden');
                } else {
                    if (chatContainer) chatContainer.classList.add('translate-x-full');
                    if (chatOverlay) chatOverlay.classList.add('hidden');
                }
            };

            if (openChatBtn) openChatBtn.addEventListener('click', () => toggleChat(true));
            if (closeChatBtn) closeChatBtn.addEventListener('click', () => toggleChat(false));
            if (chatOverlay) chatOverlay.addEventListener('click', () => toggleChat(false));
            
            const bottomNavChatBtn = document.getElementById('bottom-nav-chat-btn');
            if (bottomNavChatBtn) {
                bottomNavChatBtn.addEventListener('click', () => toggleChat(true));
            }
            
            if (chatForm) chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const message = chatInput.value.trim();
                const censoredMessage = censorMessage(message, blockedWordsList);

                if (censoredMessage && currentUserId) {
                    try {
                        addDoc(chatCollRef, {
                            text: censoredMessage,
                            userId: currentUserId,
                            createdAt: Timestamp.now()
                        });
                        chatInput.value = '';
                    } catch (error) {
                        console.error(`Gagal mengirim pesan chat: ${error.message}`); 
                    }
                }
            });
            
            const q = query(chatCollRef, orderBy("createdAt", "desc"), limit(100));
            
            if (chatUnsubscribe) chatUnsubscribe();
            
            chatUnsubscribe = onSnapshot(q, (snapshot) => {
                if (!chatMessagesEl) return;
                chatMessagesEl.innerHTML = ''; 
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push(doc.data());
                });

                messages.reverse().forEach(msg => {
                    const isMe = msg.userId === currentUserId;
                    const msgEl = document.createElement('div');
                    msgEl.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'}`;
                    
                    msgEl.innerHTML = `
                        <span class="text-xs text-gray-400 mb-1 ${isMe ? 'mr-2' : 'ml-2'}">
                            ${msg.userId.substring(0, 6)}...
                        </span>
                        <div class="max-w-[80%] break-words p-3 rounded-lg ${isMe ? 'bg-purple-600 text-white' : 'bg-gray-700 text-white'}">
                            <p class="text-sm">${msg.text}</p>
                        </div>
                    `;
                    chatMessagesEl.appendChild(msgEl);
                });
                
                chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
            }, (error) => {
                console.error(`Gagal terhubung ke chat: ${error.message}`); 
                if (chatMessagesEl) chatMessagesEl.innerHTML = '<p class="text-xs text-red-500 text-center">Gagal terhubung ke chat.</p>';
            });
        }
        
        function setupReportModal() {
            const openReportBtn = document.getElementById('open-report-btn'); 
            const openReportBtnDesktop = document.getElementById('open-report-btn-desktop'); 
            const reportModal = document.getElementById('report-modal');
            const closeReportBtn = document.getElementById('close-report-btn');
            const reportForm = document.getElementById('report-form');
            const reportTextarea = document.getElementById('report-textarea');
            const sendReportBtn = document.getElementById('send-report-btn');
            const reportStatusMsg = document.getElementById('report-status-message');

            if(openReportBtn) openReportBtn.addEventListener('click', () => {
                if (reportModal) reportModal.classList.remove('hidden');
            });
            
            if (openReportBtnDesktop) {
                openReportBtnDesktop.addEventListener('click', () => {
                    if (reportModal) reportModal.classList.remove('hidden');
                });
            }
            
            if(closeReportBtn) closeReportBtn.addEventListener('click', () => {
                if (reportModal) reportModal.classList.add('hidden');
            });
            
            if(reportModal) reportModal.addEventListener('click', (e) => {
                if (e.target === reportModal) {
                    reportModal.classList.add('hidden');
                }
            });

            if(reportForm) reportForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const reportText = reportTextarea.value.trim();
                if (reportText.length < 10) {
                    if (reportStatusMsg) reportStatusMsg.textContent = "Mohon jelaskan lebih detail (minimal 10 karakter).";
                    return;
                }

                if (sendReportBtn) sendReportBtn.disabled = true;
                if (sendReportBtn) sendReportBtn.textContent = "Mengirim...";

                try {
                    await addDoc(reportsCollRef, {
                        userId: currentUserId, 
                        report: reportText,
                        timestamp: Timestamp.now(),
                        userAgent: navigator.userAgent, 
                        page: window.location.href
                    });
                    
                    if (reportTextarea) reportTextarea.value = '';
                    if (reportStatusMsg) reportStatusMsg.textContent = "Laporan terkirim. Terima kasih!";
                    
                    setTimeout(() => {
                        if (reportModal) reportModal.classList.add('hidden');
                        if (reportStatusMsg) reportStatusMsg.textContent = "";
                    }, 2500);

                } catch (error) {
                    console.error("Gagal mengirim laporan:", error);
                    if (reportStatusMsg) reportStatusMsg.textContent = "Gagal mengirim. Coba lagi nanti.";
                } finally {
                    if (sendReportBtn) sendReportBtn.disabled = false;
                    if (sendReportBtn) sendReportBtn.textContent = "Kirim Laporan";
                }
            });
        }


        /* --- [DIKEMBALIKAN] FUNGSI DARI watch-module.js --- */

        window.openEpisodeList = async (seriesId, seriesData) => {
            currentSeriesId = seriesId;

            const episodeContainer = document.getElementById('modal-episode-list-container');
            if (!episodeContainer) return;
            episodeContainer.innerHTML = '<p class="text-xs text-gray-400 text-center">Memuat episode...</p>';
            
            const episodesCollRef = collection(db, 'series', seriesId, 'episodes'); 
            const q = query(episodesCollRef, orderBy("title", "asc")); 

            onSnapshot(q, (snapshot) => {
                episodeContainer.innerHTML = '';
                if (snapshot.empty) {
                    episodeContainer.innerHTML = '<p class="text-xs text-gray-400 text-center">Belum ada episode.</p>';
                    return;
                }

                let episodesList = [];
                snapshot.forEach(doc => {
                    episodesList.push({ id: doc.id, data: doc.data() });
                });

                episodesList.forEach(item => {
                    const episode = item.data;
                    const episodeId = item.id;
                    
                    const progressData = getWatchProgress(episodeId);
                    const isWatched = progressData.watched;
                    const isPlaying = (currentItem && currentItem.episodeId === episodeId);
                    
                    const watchedIcon = isWatched 
                        ? `<svg class="w-4 h-4 ml-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>`
                        : '';

                    const episodeEl = document.createElement('button');
                    episodeEl.className = `block w-full text-left p-2 rounded-md transition flex justify-between items-center episode-list-button ${isPlaying ? 'bg-purple-600 text-white' : 'bg-gray-700 hover:bg-gray-600'}`;
                    episodeEl.dataset.episodeId = episodeId; 
                    
                    episodeEl.innerHTML = `
                        <span class="text-sm text-gray-300 truncate">${episode.title || `(Tanpa Judul)`}</span>
                        ${watchedIcon}
                    `;

                    const videoUrl = episode.videoFiles ? episode.videoFiles['default'] : null;

                    episodeEl.onclick = () => {
                        if (videoUrl) {
                            playVideoInModal(seriesData, episode, videoUrl, episodeId);
                        } else {
                            console.warn('Video untuk episode ini tidak tersedia.');
                        }
                    };
                    
                    episodeContainer.appendChild(episodeEl);
                });
            }, (error) => { 
                console.error("Gagal memuat daftar episode: ", error);
                episodeContainer.innerHTML = '<p class="text-red-500">Gagal memuat daftar episode.</p>';
            });
        }

        function setupModalEventListeners() {
            if (closeModalBtn) closeModalBtn.addEventListener('click', closeVideoModal);
            if (videoModal) videoModal.addEventListener('click', (e) => { if (e.target === videoModal) closeVideoModal(); });
        }

        function closeVideoModal() {
            if (videoModal) videoModal.classList.add('hidden');
            saveWatchProgress(); 
            if (saveTimeout) clearTimeout(saveTimeout);
            if (modalMainPlayer) {
                modalMainPlayer.pause();
                modalMainPlayer.src = '';
            }
            
            currentItem = null;
            currentSeriesId = null; 
            
            if (watermarkEl) {
                watermarkEl.remove(); 
                watermarkEl = null;
            }
            
            if (modalMainPlayer && modalMainPlayer._timeUpdateListener) {
                modalMainPlayer.removeEventListener('timeupdate', modalMainPlayer._timeUpdateListener);
                modalMainPlayer._timeUpdateListener = null;
            }
        }

        async function playVideoInModal(seriesData, episodeData, videoUrl, episodeId) {
            try {
                currentItem = { ...seriesData, ...episodeData, episodeId: episodeId };
                
                if (!videoUrl) {
                    alert("Gagal memuat video: URL tidak sah.");
                    return;
                }

                const loadingIcon = document.getElementById('video-loading-icon');
                if (loadingIcon) loadingIcon.src = faviconUrl || mainLogoUrl || 'https://placehold.co/64x64/374151/FFF?text=...'; 
                if (loadingIcon) loadingIcon.classList.remove('hidden'); 
                if (loadingIcon) loadingIcon.classList.add('animate-pulse');
                
                if (modalMainPlayer) modalMainPlayer.style.display = 'none'; 
                if (videoModal) videoModal.classList.remove('hidden'); 

                const allEpisodeButtons = document.querySelectorAll('#modal-episode-list-container .episode-list-button');
                allEpisodeButtons.forEach(btn => {
                    if (btn.dataset.episodeId === episodeId) {
                        btn.classList.add('bg-purple-600', 'text-white');
                        btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                    } else {
                        btn.classList.remove('bg-purple-600', 'text-white');
                        btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                    }
                });

                const modalTitleEl = document.getElementById('modal-content-title');
                if (!modalTitleEl || modalTitleEl.textContent === "Memuat judul...") {
                    if (document.getElementById('modal-thumbnail')) document.getElementById('modal-thumbnail').src = seriesData.thumbnailUrl;
                    if (modalTitleEl) modalTitleEl.textContent = seriesData.title;
                    if (document.getElementById('modal-content-description')) document.getElementById('modal-content-description').textContent = seriesData.description || 'Tidak ada deskripsi.';
                    if (document.getElementById('modal-content-rating')) document.getElementById('modal-content-rating').textContent = (seriesData.rating || 'N/A').replace(' / 10', '');
                    if (document.getElementById('modal-content-vote')) document.getElementById('modal-content-vote').textContent = (seriesData.scored_by || 0).toLocaleString('id-ID') + ' Vote';
                    if (document.getElementById('modal-content-episodes')) document.getElementById('modal-content-episodes').textContent = `${seriesData.episodeCount || 0} Eps`;
                }

                if (modalMainPlayer) modalMainPlayer.src = videoUrl;

                const progressData = getWatchProgress(episodeId);
                const progress = progressData.time;

                createWatermark(); 
                
                if (modalMainPlayer) modalMainPlayer.addEventListener('canplay', () => {
                    if (loadingIcon) loadingIcon.classList.add('hidden'); 
                    if (modalMainPlayer) modalMainPlayer.style.display = 'block'; 
                    if (progress > 0) {
                        modalMainPlayer.currentTime = progress;
                    }
                    modalMainPlayer.play().catch(e => {
                        console.warn("Autoplay dicegah, mulai dalam keadaan dijeda.", e);
                    });
                }, { once: true });
                
                if (modalMainPlayer) setupVideoProgressSaving(modalMainPlayer);

                if (modalMainPlayer) modalMainPlayer.addEventListener('error', (e) => {
                     console.error("Video player error:", e, modalMainPlayer.error);
                     if (loadingIcon) loadingIcon.src = 'https://placehold.co/64x64/ef4444/FFFFFF?text=Error';
                     if (loadingIcon) loadingIcon.classList.remove('animate-pulse');
                }, { once: true });
                
                logVideoPlay(currentSeriesId);

            } catch (error) { console.error("Gagal memuat video:", error); }
        }

        function createWatermark() {
            if (watermarkEl) {
                watermarkEl.remove();
            }
            
            if (!mainLogoUrl) return;

            watermarkEl = document.createElement('div');
            watermarkEl.style.position = 'absolute';
            watermarkEl.style.top = '0.5rem'; 
            watermarkEl.style.right = '0.5rem'; 
            watermarkEl.style.padding = '0.25rem'; 
            watermarkEl.style.backgroundColor = 'rgba(0, 0, 0, 0.7)'; 
            watermarkEl.style.borderRadius = '0.25rem'; 
            watermarkEl.style.zIndex = '21'; 
            watermarkEl.style.pointerEvents = 'none'; 
            
            const img = document.createElement('img');
            img.src = mainLogoUrl;
            img.style.height = '1.75rem'; 
            img.style.width = 'auto';
            img.style.objectFit = 'contain';
            img.style.opacity = '0.8';
            
            watermarkEl.appendChild(img);
            if (videoContainer) videoContainer.appendChild(watermarkEl);
        }

        function getWatchProgress(episodeId) {
            try {
                const progressData = localStorage.getItem('aisnimeWatchProgress');
                if (progressData) {
                    const episodes = JSON.parse(progressData);
                    if (episodes && episodes[episodeId]) {
                        if (typeof episodes[episodeId] === 'object') {
                            return episodes[episodeId];
                        } else if (typeof episodes[episodeId] === 'number') {
                            return { time: episodes[episodeId], watched: false };
                        }
                    }
                }
                return { time: 0, watched: false };
            } catch (error) {
                console.error("Gagal mengambil progres dari localStorage:", error);
                return { time: 0, watched: false };
            }
        }

        function saveWatchProgress() {
            if (!currentItem || !currentItem.episodeId || !modalMainPlayer) return;
            
            const episodeId = currentItem.episodeId;
            const currentTime = modalMainPlayer.currentTime;
            const duration = modalMainPlayer.duration;
            
            if (currentTime < 10 || isNaN(duration) || duration === 0) return; 

            try {
                let progressData = localStorage.getItem('aisnimeWatchProgress');
                let episodes = {};
                if (progressData) {
                    episodes = JSON.parse(progressData);
                }

                let episodeProgress = getWatchProgress(episodeId);
                episodeProgress.time = currentTime;

                if (currentTime / duration >= 0.95) {
                    episodeProgress.watched = true;
                }
                
                episodes[episodeId] = episodeProgress;
                localStorage.setItem('aisnimeWatchProgress', JSON.stringify(episodes));
            } catch (error) {
                console.error("Gagal menyimpan progres ke localStorage:", error);
            }
        }

        function setupVideoProgressSaving(player) {
            if (saveTimeout) clearTimeout(saveTimeout);
            
            const timeUpdateListener = () => {
                if (saveTimeout) clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveWatchProgress, 5000); 
            };
            
            player.addEventListener('timeupdate', timeUpdateListener);
            player._timeUpdateListener = timeUpdateListener; 
        }
        
        async function logVideoPlay(seriesId) {
            try {
                const now = Date.now();
                const oneHour = 60 * 60 * 1000;
                const viewTimestampsKey = 'aisnimeViewTimestamps';
                
                let timestamps = {};
                try {
                    const storedTimestamps = localStorage.getItem(viewTimestampsKey);
                    if (storedTimestamps) {
                        timestamps = JSON.parse(storedTimestamps);
                    }
                } catch (e) {
                    console.error("Gagal memuat timestamps dari localStorage", e);
                    timestamps = {};
                }

                const lastViewTime = timestamps[seriesId] || 0;

                if (now - lastViewTime > oneHour) {
                    console.log(`Mencatat penonton baru untuk serial ${seriesId}.`);
                    
                    const seriesRef = doc(seriesCollRef, seriesId); 
                    await updateDoc(seriesRef, {
                        viewCount: increment(1)
                    });
                    
                    const statsRef = doc(settingsCollRef, 'analytics'); 
                    await setDoc(statsRef, {
                        totalViews: increment(1)
                    }, { merge: true });

                    timestamps[seriesId] = now;
                    localStorage.setItem(viewTimestampsKey, JSON.stringify(timestamps));

                } else {
                     console.log(`Penonton untuk serial ${seriesId} sudah dihitung dalam 1 jam terakhir. Dilewati.`);
                }

            } catch (error) {
                 console.error("Gagal mencatat pemutaran video:", error);
            }
        }
        
        async function playLatestEpisode(seriesId, seriesData) {
            await ensurePlayerModuleIsLoaded(); 
            
            if (videoModal) videoModal.classList.remove('hidden');
            const loadingIcon = document.getElementById('video-loading-icon');
            if (loadingIcon) loadingIcon.style.display = 'block';
            if (modalMainPlayer) modalMainPlayer.style.display = 'none';

            if (document.getElementById('modal-thumbnail')) document.getElementById('modal-thumbnail').src = seriesData.thumbnailUrl;
            if (document.getElementById('modal-content-title')) document.getElementById('modal-content-title').textContent = seriesData.title;
            if (document.getElementById('modal-content-description')) document.getElementById('modal-content-description').textContent = seriesData.description || 'Tidak ada deskripsi.';
            if (document.getElementById('modal-content-rating')) document.getElementById('modal-content-rating').textContent = (seriesData.rating || 'N/A').replace(' / 10', '');
            if (document.getElementById('modal-content-vote')) document.getElementById('modal-content-vote').textContent = (seriesData.scored_by || 0).toLocaleString('id-ID') + ' Vote';
            if (document.getElementById('modal-content-episodes')) document.getElementById('modal-content-episodes').textContent = `${seriesData.episodeCount || 0} Eps`;

            window.openEpisodeList(seriesId, seriesData); 

            try {
                const episodesCollRef = collection(db, 'series', seriesId, 'episodes');
                const q = query(episodesCollRef, orderBy("episodeNumber", "desc"), limit(1));
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    const episodeDoc = snapshot.docs[0];
                    const episodeData = episodeDoc.data();
                    const videoUrl = episodeData.videoFiles ? episodeData.videoFiles['default'] : null;

                    if (videoUrl) {
                        playVideoInModal(seriesData, episodeData, videoUrl, episodeDoc.id);
                    } else {
                        console.warn("Episode terbaru ditemukan tapi tidak ada URL video.");
                        if (loadingIcon) loadingIcon.style.display = 'none';
                    }
                } else {
                    if (loadingIcon) loadingIcon.style.display = 'none';
                }
            } catch (error) {
                console.error("Gagal mengambil episode terbaru:", error);
                if (loadingIcon) loadingIcon.style.display = 'none';
            }
        }
        
        async function ensurePlayerModuleIsLoaded() {
            if (isWatchModuleLoaded) return; 
            
            try {
                videoModal = document.getElementById('video-modal');
                videoContainer = document.getElementById('video-container'); 
                closeModalBtn = document.getElementById('close-modal-btn');
                modalMainPlayer = document.getElementById('modal-main-player');
                
                setupModalEventListeners();
                isWatchModuleLoaded = true;
                
            } catch (e) {
                console.error("Gagal menginisialisasi DOM pemutar video:", e);
                alert("Terjadi error saat memuat elemen pemutar video.");
            }
        }
        
        /* --- [DIKEMBALIKAN] FUNGSI DARI async.js --- */
        
        async function main() {
            try {
                contentListEl = document.getElementById('content-list');
                contentRowsContainer = document.getElementById('content-rows-container'); 
                mainLogoImg = document.getElementById('main-logo');
                mainTitleText = document.getElementById('main-title-text');
                genreSidebar = document.getElementById('genre-sidebar');
                genreOverlay = document.getElementById('genre-overlay');
                openGenreBtn = document.getElementById('open-genre-btn');
                closeGenreBtn = document.getElementById('close-genre-btn');
                genreListMobile = document.getElementById('genre-list-mobile');
                genreListDesktop = document.getElementById('genre-list-desktop');
                videoModal = document.getElementById('video-modal');
                closeModalBtn = document.getElementById('close-modal-btn');
                modalMainPlayer = document.getElementById('modal-main-player');
                videoContainer = document.getElementById('video-container');


                /* --- Firebase Auth --- */
                try {
                    await signInAnonymously(auth);
                } catch (authError) {
                    console.error(`Autentikasi Gagal: ${authError.message}`); 
                    const loadingMsg = document.getElementById('loading-overlay').querySelector('p');
                    if(loadingMsg) {
                        loadingMsg.textContent = "Gagal terhubung ke server autentikasi. Pastikan domain ini telah diizinkan di Firebase Auth.";
                        loadingMsg.classList.add("text-red-500", "p-4");
                    }
                    return; 
                }
                currentUserId = auth.currentUser?.uid || crypto.randomUUID();
                
                await loadSettings();
                logPageView(); 
                setupChat(); 
                setupReportModal();
                handleDeepLink();
                loadDynamicNavLinks(); 
            } catch(e) { 
                console.error(`Initialization failed: ${e.message}`); 
                document.body.innerHTML = `<div class="bg-red-900 text-white p-8 rounded-lg shadow-2xl max-w-2xl mx-auto mt-20"><h1 class="text-3xl font-bold mb-4">Koneksi Gagal!</h1><p>Gagal terhubung ke server.</p></div>`;
            }
        }

        async function loadSettings() {
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingFavicon = document.getElementById('loading-favicon');
            const bottomNavFavicon = document.getElementById('bottom-nav-favicon'); 

            try {
                const urlParams = new URLSearchParams(window.location.search);
                const accessCode = urlParams.get('code');

                const faviconSnap = await getDoc(doc(settingsCollRef, 'favicon'));
                if (faviconSnap.exists() && faviconSnap.data().url) {
                    faviconUrl = faviconSnap.data().url; 
                    if (document.getElementById('favicon')) document.getElementById('favicon').href = faviconUrl; 
                    if (loadingFavicon) loadingFavicon.src = faviconUrl;
                    if (bottomNavFavicon) bottomNavFavicon.src = faviconUrl; 
                }
                
                const settingsKeys = ['background', 'mainLogo', 'maintenanceMode', 'censorship'];
                const promises = settingsKeys.map(key => getDoc(doc(settingsCollRef, key)));
                const [backgroundSnap, mainLogoSnap, maintenanceSnap, censorSnap] = await Promise.all(promises);
                
                if (censorSnap.exists() && censorSnap.data().blockedWords) {
                    blockedWordsList = censorSnap.data().blockedWords; 
                }

                const maintenanceMode = maintenanceSnap.exists() && maintenanceSnap.data().status === 1;
                const mainContent = document.getElementById('main-content');
                const maintenanceOverlay = document.getElementById('maintenance-overlay');

                if (backgroundSnap.exists() && backgroundSnap.data().url) {
                    document.body.style.backgroundImage = `url('${backgroundSnap.data().url}')`;
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundPosition = 'center';
                    document.body.style.backgroundAttachment = 'fixed';
                }

                if (maintenanceMode && accessCode !== '3396') {
                    if (mainContent) mainContent.classList.add('hidden');
                    if (maintenanceOverlay) maintenanceOverlay.classList.remove('hidden');
                    if (faviconSnap.exists() && faviconSnap.data().url) {
                        if (document.getElementById('maintenance-logo')) document.getElementById('maintenance-logo').src = faviconUrl;
                    }
                    if (loadingOverlay) loadingOverlay.classList.add('hidden');
                } else {
                    if (maintenanceOverlay) maintenanceOverlay.classList.add('hidden');
                    
                    const mainLogoImgMobile = document.getElementById('main-logo-mobile');
                    const mainTitleTextMobile = document.getElementById('main-title-text-mobile');

                    if (mainLogoImg && mainLogoSnap.exists() && mainLogoSnap.data().url) {
                        mainLogoUrl = mainLogoSnap.data().url; 
                        mainLogoImg.src = mainLogoUrl; 
                        mainLogoImg.classList.remove('hidden');
                        if (mainTitleText) mainTitleText.classList.add('hidden');

                        if (mainLogoImgMobile) { mainLogoImgMobile.src = mainLogoUrl; mainLogoImgMobile.classList.remove('hidden'); } 
                        if (mainTitleTextMobile) mainTitleTextMobile.classList.add('hidden'); 
                    } else {
                        if (mainTitleText) mainTitleText.textContent = "AISNIME"; 
                        if (mainTitleText) mainTitleText.classList.remove('hidden');
                        if (mainLogoImg) mainLogoImg.classList.add('hidden');
                        
                        if (mainTitleTextMobile) { mainTitleTextMobile.textContent = "AISNIME"; mainTitleTextMobile.classList.remove('hidden'); } 
                        if (mainLogoImgMobile) mainLogoImgMobile.classList.add('hidden'); 
                        
                        console.warn(`Logo utama tidak ditemukan. Snap exists: ${mainLogoSnap.exists()}`); 
                    }
                    
                    
                    loadInitialContent();
                    loadCustomContentRows(); 
                    setupSearchListener();
                    setupEventListeners(); 
                    
                    if (loadingOverlay) loadingOverlay.classList.add('hidden');
                    if (mainContent) mainContent.classList.remove('hidden');
                }

            } catch (error) { 
                console.error(`Gagal memuat pengaturan: ${error.message}`); 
                if (loadingFavicon) loadingFavicon.src = 'https://placehold.co/64x64/ef4444/FFFFFF?text=Error';
                if (loadingFavicon) loadingFavicon.classList.remove('animate-pulse');
                const loadingP = document.getElementById('loading-overlay').querySelector('p');
                if (loadingP) loadingP.textContent = "Gagal memuat pengaturan. Coba refresh.";
            }
        }
        
        async function loadCustomContentRows() {
            const q = query(contentRowsCollRef, orderBy("order", "asc"));
            try {
                const snapshot = await getDocs(q);
                for (const docSnap of snapshot.docs) {
                    const rowData = docSnap.data();
                    const seriesIds = rowData.seriesIds || [];
                    if (seriesIds.length > 0) {
                        const seriesPromises = seriesIds.map(id => getDoc(doc(seriesCollRef, id)));
                        const seriesDocs = await Promise.all(seriesPromises);
                        
                        const rowSeriesContent = seriesDocs
                            .filter(doc => doc.exists())
                            .map(doc => ({ id: doc.id, data: doc.data() }));

                        if (rowSeriesContent.length > 0) {
                            renderCustomRow(rowData.title, rowSeriesContent);
                        }
                    }
                }
            } catch (error) {
                console.error("Gagal memuat baris konten kustom:", error);
            }
        }
        
        async function loadDynamicNavLinks() {
            const container = document.getElementById('dynamic-nav-links');
            if (!container) return;
            
            container.innerHTML = ''; 
            const q = query(navLinksCollRef, orderBy("order", "asc"));
            try {
                const snapshot = await getDocs(q);
                
                const genreFilter = document.getElementById('genre-filter-desktop');
                if (snapshot.empty) {
                    container.style.display = 'none';
                    if(genreFilter) genreFilter.classList.remove('pt-4', 'border-t');
                    return;
                }
                
                if(genreFilter) genreFilter.classList.add('pt-4', 'border-t');
                
                snapshot.forEach(docSnap => {
                    const linkData = docSnap.data();
                    const linkEl = document.createElement('a');
                    linkEl.href = linkData.url;
                    linkEl.target = "_blank"; 
                    linkEl.rel = "noopener noreferrer";
                    linkEl.className = "relative group block p-2 rounded-lg text-white font-semibold hover:bg-gray-700 transition-colors flex justify-center"; 
                    
                    linkEl.innerHTML = `
                        <svg class="w-6 h-6 flex-shrink-0 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899l4-4a4 4 0 10-5.656-5.656l-1.102 1.101"></path></svg>
                        <span class="absolute left-full top-1/2 -translate-y-1/2 ml-3 px-3 py-1 bg-gray-900 shadow-lg rounded-md text-sm text-white hidden lg:group-hover:block whitespace-nowrap z-50">
                            ${linkData.title}
                        </span>
                    `;
                    container.appendChild(linkEl);
                });
            } catch (error) {
                console.error("Gagal memuat link navigasi:", error);
                container.innerHTML = '<p class="text-sm text-red-400">Gagal memuat navigasi.</p>';
            }
        }
        
        async function logPageView() {
            try {
                const hasVisited = localStorage.getItem('aisnimeVisited');
                if (!hasVisited) {
                    const statsRef = doc(settingsCollRef, 'analytics');
                    await setDoc(statsRef, {
                        uniqueVisitors: increment(1)
                    }, { merge: true });
                    localStorage.setItem('aisnimeVisited', 'true');
                }
            } catch (error) {
                console.error(`Gagal mencatat kunjungan unik: ${error.message}`); 
            }
        }

        async function loadAndShowEpisodeList(seriesId, seriesData) {
            
            await ensurePlayerModuleIsLoaded(); 
            
            if (videoModal) videoModal.classList.remove('hidden');
            const loadingIcon = document.getElementById('video-loading-icon');
            if (loadingIcon) loadingIcon.style.display = 'block';
            if (modalMainPlayer) modalMainPlayer.style.display = 'none';

            if (document.getElementById('modal-thumbnail')) document.getElementById('modal-thumbnail').src = seriesData.thumbnailUrl;
            if (document.getElementById('modal-content-title')) document.getElementById('modal-content-title').textContent = seriesData.title;
            if (document.getElementById('modal-content-description')) document.getElementById('modal-content-description').textContent = seriesData.description || 'Tidak ada deskripsi.';
            if (document.getElementById('modal-content-rating')) document.getElementById('modal-content-rating').textContent = (seriesData.rating || 'N/A').replace(' / 10', '');
            if (document.getElementById('modal-content-vote')) document.getElementById('modal-content-vote').textContent = (seriesData.scored_by || 0).toLocaleString('id-ID') + ' Vote';
            if (document.getElementById('modal-content-episodes')) document.getElementById('modal-content-episodes').textContent = `${seriesData.episodeCount || 0} Eps`;

            openEpisodeList(seriesId, seriesData); 
        }
        
        async function handleDeepLink() {
            const params = new URLSearchParams(window.location.search);
            const seriesId = params.get('series');
            const episodeId = params.get('episode');

            if (seriesId && episodeId) {
                console.log(`Deep link terdeteksi: Series ${seriesId}, Episode ${episodeId}`);
                
                try {
                    await ensurePlayerModuleIsLoaded();
                    
                    const seriesDocRef = doc(seriesCollRef, seriesId);
                    const episodeDocRef = doc(collection(db, seriesCollRef.path, seriesId, 'episodes'), episodeId);
                    
                    const [seriesSnap, episodeSnap] = await Promise.all([
                        getDoc(seriesDocRef),
                        getDoc(episodeDocRef)
                    ]);

                    if (!seriesSnap.exists() || !episodeSnap.exists()) {
                        console.error("Gagal deep link: Serial atau episode tidak ditemukan.");
                        return;
                    }

                    const seriesData = seriesSnap.data();
                    const episodeData = episodeSnap.data();
                    const videoUrl = episodeData.videoFiles ? episodeData.videoFiles['default'] : null;

                    if (videoUrl) {
                        playVideoInModal(seriesData, episodeData, videoUrl, episodeId);
                        openEpisodeList(seriesId, seriesData);
                    } else {
                        console.error("Gagal deep link: URL video tidak ditemukan.");
                    }
                    
                    history.replaceState(null, '', window.location.pathname);

                } catch (error) {
                    console.error("Error saat menangani deep link:", error);
                }
            }
        }

        
        
        /* [DIHAPUS] Blok duplikat dari async function playVideoInModal() hingga async function playLatestEpisode() */
        

        /* Menunggu sehingga DOM sedia menjalankan 'main' */
        window.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
