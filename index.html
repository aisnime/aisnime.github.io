<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AISNIME</title>
    
    <meta name="theme-color" content="#8B5CF6">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://i.imgur.com/7b4w4qH.png">
    
    <link rel="icon" id="favicon" href="">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-900 text-white">
    <!-- Konten Normal (Awalnya ditampilkan) -->
    <div id="main-content" class="overlay">
        <div class="container mx-auto p-4 lg:p-8">
            
            <!-- [DIUBAH] Kolom Atas (Header) kini menjadi grid 3-kolom (Poster di kiri, Logo/Search di kanan) -->
            <div class="lg:grid lg:grid-cols-3 lg:gap-8 lg:items-center mb-8">
                
                <!-- [DIUBAH] Kolom Kiri: Poster Landscape (Span 1) -->
                <div class="hidden lg:block lg:col-span-1">
                    <div class="aspect-video w-full bg-gray-800 rounded-lg overflow-hidden shadow-lg">
                        <!-- [BARU] Wrapper untuk slider -->
                        <div id="header-poster-slider" class="relative w-full h-full">
                            <!-- Poster akan dimasukkan oleh JS di sini -->
                        </div>
                         <!-- [BARU] Navigasi titik slider -->
                        <div id="slider-dots" class="absolute bottom-2 left-1/2 -translate-x-1/2 flex space-x-2">
                            <!-- Titik akan dimasukkan oleh JS -->
                        </div>
                    </div>
                </div>

                <!-- [DIUBAH] Kolom Kanan: Logo dan Pencarian (Span 2) -->
                <div class="lg:col-span-2"> 
                    <!-- [DIUBAH] Header kini lg:text-right -->
                    <header class="text-center lg:text-right mb-4 lg:mb-0 relative">
                        <!-- [DIUBAH] Logo kini lg:ml-auto dan lg:mx-0 -->
                        <img id="main-logo" src="" alt="Logo Aplikasi" class="w-auto h-10 mx-auto lg:ml-auto lg:mx-0 mb-4 hidden">
                        <h1 id="main-title-text" class="text-5xl lg:text-4xl font-extrabold text-white drop-shadow-lg"></h1>
                        
                        <!-- Tombol Buka Chat Mobile (posisi tetap, tapi disembunyikan di lg) -->
                        <button id="open-chat-btn" class="absolute top-0 right-0 p-2 text-white bg-gray-700 bg-opacity-50 rounded-full lg:hidden">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 21l1.949-3.828a9.863 9.863 0 01-1.042-4.172C3.907 7.582 7.94 4 12 4c4.97 0 9 3.582 9 8z"></path></svg>
                        </button>
                    </header>
                    
                    <!-- Pencarian (sekarang di bawah logo di kanan) -->
                    <!-- [DIUBAH] Form kini lg:ml-auto dan lg:mr-0 -->
                    <form id="search-form" class="w-full max-w-xl mx-auto lg:ml-auto lg:mr-0 mt-4 flex items-center space-x-2">
                        <input type="search" id="search-input" placeholder="Cari berdasarkan judul atau genre..." class="w-full bg-gray-700 bg-opacity-50 border border-gray-600 rounded-full py-3 px-6 text-white focus:ring-2 focus:ring-purple-500 transition">
                    </form>
                </div>

            </div>


            <!-- [BARU] Wrapper untuk layout desktop Grid (Konten + Chat) -->
            <div class="relative lg:grid lg:grid-cols-3 lg:gap-8">
                
                <!-- [DIUBAH] Kolom Kiri: Konten -->
                <main class="main-content-container p-6 lg:col-span-2">
                    <h2 class="text-3xl font-bold mb-6 border-b border-gray-700 pb-3">UPDATE TERBARU</h2>
                    <!-- [DIUBAH] Menggunakan sm:grid-cols-2 untuk semua ukuran layar (kecuali xs) -->
                    <div id="content-list" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <p id="no-content-message" class="text-gray-500 col-span-full text-center py-8">Memuat konten...</p>
                    </div>
                    <!-- [DIHAPUS] Kontainer untuk tombol "Muat Lebih Banyak" -->
                </main>

                <!-- [DIUBAH] Kolom Kanan: Chat -->
                <div id="chat-container" class="fixed top-0 right-0 h-full w-80 bg-gray-800 shadow-xl z-50 transform translate-x-full transition-transform duration-300 
                                                lg:block lg:relative lg:translate-x-0 lg:z-auto lg:w-full lg:col-span-1 lg:sticky lg:top-8" 
                     style="max-height: 100vh; lg:max-height: calc(100vh - 10rem);"> <!-- [DIUBAH] Sesuaikan tinggi maks -->
                    
                    <!-- Wrapper untuk styling (border, bg) dan flex column -->
                    <div class="bg-gray-800 lg:bg-opacity-50 rounded-lg flex flex-col h-full">
                        <!-- Header Chat -->
                        <div class="flex justify-between items-center p-4 border-b border-gray-700 flex-shrink-0">
                            <h3 class="font-bold text-white">Chat Publik</h3>
                            <button id="close-chat-btn" class="text-gray-400 hover:text-white text-2xl lg:hidden">&times;</button>
                        </div>
                        
                        <!-- Area Pesan -->
                        <div id="chat-messages" class="flex-grow p-4 space-y-3 overflow-y-auto">
                            <!-- Pesan akan dimuat di sini -->
                            <p class="text-xs text-gray-500 text-center">Menyambungkan ke chat...</p>
                        </div>
                        
                        <!-- Input Pesan -->
                        <div class="p-4 border-t border-gray-700 flex-shrink-0">
                            <form id="chat-form" class="flex space-x-2">
                                <input type="text" id="chat-input" placeholder="Ketik pesan..." class="flex-1 bg-gray-700 rounded-full py-2 px-4 text-white focus:ring-2 focus:ring-purple-500" autocomplete="off">
                                <button type="submit" id="chat-send-btn" class="bg-purple-600 hover:bg-purple-700 rounded-full w-10 h-10 flex items-center justify-center flex-shrink-0">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 16.5V3.5a1 1 0 00.894-1.053l-1.48 8.88A1 1 0 0010.894 2.553z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- [BARU] Overlay Chat Mobile -->
    <div id="chat-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>

    <!-- Tampilan Maintenance (Awalnya disembunyikan) -->
    <div id="maintenance-overlay" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center text-center bg-gray-900 p-4">
        <img id="maintenance-logo" src="" alt="Logo" class="w-40 h-40 rounded-full mb-6 border-4 border-gray-700 shadow-lg">
        <h1 class="text-4xl font-bold text-white">MAINTENANCE</h1>
        <p class="text-gray-300 mt-2 max-w-md">Mohon Maaf, Kami sedang melakukan beberapa pembaruan</p>
    </div>

    <!-- [DIHAPUS] MODAL DAFTAR EPISODE -->
    
    <!-- [DIHAPUS] MODAL VIDEO -->
    
    <script type="module">
        // [DIPERBAIKI] Menggunakan path absolut domain baru Anda
        import { auth, db, seriesCollRef, settingsCollRef } from 'https://aisnime.site/firebase-init.js';
        import { signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // [DIUBAH] Impor 'limit'
        import { collection, query, where, orderBy, onSnapshot, doc, getDoc, getDocs, updateDoc, deleteDoc, setDoc, Timestamp, increment, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Deklarasi variabel di scope yang lebih luas
        let contentListEl, mainLogoImg, mainTitleText;
        let allSeriesContent = [];
        let filteredSeriesContent = []; 
        
        let isLoadingMore = false;
        let isSearching = false;
        let currentDisplayCount = 0;
        const MOBILE_LIMIT = 8; // 4 baris x 2 kolom
        const DESKTOP_LIMIT = 20; // 10 baris x 2 kolom
        
        // [BARU] Variabel Chat
        let chatCollRef = null;
        let currentUserId = null;
        let chatUnsubscribe = null; // Untuk listener chat
        
        let faviconUrl = ''; // [BARU] Untuk menyimpan URL favicon

        async function main() {
            try {
                // Inisialisasi variabel elemen DOM
                contentListEl = document.getElementById('content-list');
                mainLogoImg = document.getElementById('main-logo');
                mainTitleText = document.getElementById('main-title-text');

                await signInAnonymously(auth);
                currentUserId = auth.currentUser?.uid || crypto.randomUUID(); // Dapatkan User ID
                
                await loadSettings();
                logPageView(); 
                setupChat(); // [BARU] Setup chat
            } catch(e) { 
                console.error("Initialization failed", e);
                document.body.innerHTML = `<div class="bg-red-900 text-white p-8 rounded-lg shadow-2xl max-w-2xl mx-auto mt-20"><h1 class="text-3xl font-bold mb-4">Koneksi Gagal!</h1><p>Gagal terhubung ke server.</p></div>`;
            }
        }

        async function loadSettings() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const accessCode = urlParams.get('code');

                const settingsKeys = ['background', 'mainLogo', 'favicon', 'maintenanceMode', 'headerPosters']; // [DIUBAH] ke 'headerPosters'
                const promises = settingsKeys.map(key => getDoc(doc(settingsCollRef, key)));
                const [backgroundSnap, mainLogoSnap, faviconSnap, maintenanceSnap, headerPostersSnap] = await Promise.all(promises); // [DIUBAH]

                const maintenanceMode = maintenanceSnap.exists() && maintenanceSnap.data().status === 1;
                const mainContent = document.getElementById('main-content');
                const maintenanceOverlay = document.getElementById('maintenance-overlay');

                if (backgroundSnap.exists() && backgroundSnap.data().url) {
                    document.body.style.backgroundImage = `url('${backgroundSnap.data().url}')`;
                }

                if (maintenanceMode && accessCode !== '3396') {
                    mainContent.classList.add('hidden');
                    maintenanceOverlay.classList.remove('hidden');
                    if (faviconSnap.exists() && faviconSnap.data().url) {
                        document.getElementById('maintenance-logo').src = faviconSnap.data().url;
                    }
                } else {
                    mainContent.classList.remove('hidden');
                    maintenanceOverlay.classList.add('hidden');
                    
                    if (mainLogoImg && mainLogoSnap.exists() && mainLogoSnap.data().url) {
                        mainLogoImg.src = mainLogoSnap.data().url;
                        mainLogoImg.classList.remove('hidden');
                        mainTitleText.classList.add('hidden');
                    }
                    if (faviconSnap.exists() && faviconSnap.data().url) {
                        document.getElementById('favicon').href = faviconSnap.data().url;
                        faviconUrl = faviconSnap.data().url; // [BARU] Simpan URL favicon
                    }
                    
                    // [DIUBAH] Muat Header Poster (Slider)
                    const sliderContainer = document.getElementById('header-poster-slider');
                    const dotsContainer = document.getElementById('slider-dots');
                    
                    if (sliderContainer && headerPostersSnap.exists() && headerPostersSnap.data().urls && headerPostersSnap.data().urls.length > 0) {
                        const posters = headerPostersSnap.data().urls;
                        sliderContainer.innerHTML = ''; // Kosongkan placeholder
                        dotsContainer.innerHTML = ''; // Kosongkan titik

                        posters.forEach((url, index) => {
                            // Tambah gambar poster
                            const img = document.createElement('img');
                            img.src = url;
                            img.alt = `Header Poster ${index + 1}`;
                            // [DIUBAH] Terapkan kelas transisi dan sembunyikan semua kecuali yang pertama
                            img.className = `header-poster-img absolute w-full h-full object-cover transition-opacity duration-1000 ease-in-out ${index === 0 ? 'opacity-100' : 'opacity-0'}`;
                            sliderContainer.appendChild(img);
                            
                            // Tambah titik navigasi
                            const dot = document.createElement('div');
                            dot.className = `slider-dot w-2 h-2 rounded-full cursor-pointer ${index === 0 ? 'bg-white' : 'bg-gray-500'}`;
                            dot.dataset.index = index;
                            dotsContainer.appendChild(dot);
                        });
                        
                        startHeaderSlider(posters.length);
                        
                    } else if (sliderContainer) {
                        // Fallback jika tidak ada poster di DB
                        sliderContainer.innerHTML = `<img src="https://placehold.co/1600x900/1F2937/FFFFFF?text=Poster+Landscape" alt="Header Poster" class="w-full h-full object-cover">`;
                    }
                    
                    loadInitialContent();
                    setupSearchListener();
                    setupEventListeners(); // [DIUBAH] setupEventListeners yang lebih ringan
                }

            } catch (error) { console.error("Gagal memuat pengaturan:", error); }
        }
        
        // [BARU] Fungsi untuk slider poster header
        let currentSlideIndex = 0;
        let slideInterval;
        function startHeaderSlider(totalSlides) {
            if (totalSlides <= 1) return; // Jangan jalankan slider jika hanya 1 gambar
            
            const images = document.querySelectorAll('.header-poster-img');
            const dots = document.querySelectorAll('.slider-dot');

            const showSlide = (index) => {
                images.forEach((img, i) => {
                    img.classList.toggle('opacity-100', i === index);
                    img.classList.toggle('opacity-0', i !== index);
                });
                dots.forEach((dot, i) => {
                    dot.classList.toggle('bg-white', i === index);
                    dot.classList.toggle('bg-gray-500', i !== index);
                });
                currentSlideIndex = index;
            };

            // Hentikan interval lama jika ada
            if (slideInterval) clearInterval(slideInterval);
            
            slideInterval = setInterval(() => {
                let nextIndex = (currentSlideIndex + 1) % totalSlides;
                showSlide(nextIndex);
            }, 5000); // Ganti slide setiap 5 detik

            // (Opsional) Klik titik untuk ganti slide
            dots.forEach(dot => {
                dot.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index, 10);
                    showSlide(index);
                    // Reset interval
                    clearInterval(slideInterval);
                    slideInterval = setInterval(() => {
                        let nextIndex = (currentSlideIndex + 1) % totalSlides;
                        showSlide(nextIndex);
                    }, 5000);
                });
            });
        }


        function loadInitialContent() {
            // [DIUBAH] Hapus orderBy, kita akan sort manual
            const q = query(seriesCollRef);
            onSnapshot(q, (snapshot) => {
                allSeriesContent = snapshot.docs.map(doc => ({id: doc.id, data: doc.data()}));
                
                // [DIUBAH] Urutkan data secara manual di JavaScript
                allSeriesContent.sort((a, b) => {
                    const timeA = (a.data.updatedAt || a.data.createdAt || { toMillis: () => 0 }).toMillis();
                    const timeB = (b.data.updatedAt || b.data.createdAt || { toMillis: () => 0 }).toMillis();
                    return timeB - timeA; // Urutkan dari yang terbaru (descending)
                });
                
                filteredSeriesContent = allSeriesContent; // Set data filter awal
                currentDisplayCount = 0; // Reset hitungan
                contentListEl.innerHTML = ''; // Kosongkan daftar
                renderMoreContent(); // Render batch pertama

            }, (error) => {
                console.error("Gagal memuat konten:", error);
                if (contentListEl) {
                    contentListEl.innerHTML = '<p class="text-red-500 col-span-full text-center py-8">Error memuat konten.</p>';
                }
            });
        }

        function setupSearchListener() {
            const searchInput = document.getElementById('search-input');
            const searchForm = document.getElementById('search-form');
            
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    
                    if (searchTerm.length > 0) {
                        isSearching = true; // [BARU] Aktifkan mode pencarian
                        filteredSeriesContent = allSeriesContent.filter(item => 
                            item.data.title.toLowerCase().includes(searchTerm) ||
                            (item.data.genre && item.data.genre.join(', ').toLowerCase().includes(searchTerm))
                        );
                    } else {
                        isSearching = false; // Matikan mode pencarian
                        filteredSeriesContent = allSeriesContent;
                    }
                    // Reset tampilan untuk data baru
                    currentDisplayCount = 0;
                    contentListEl.innerHTML = '';
                    renderMoreContent(); // Render batch pertama dari hasil filter/penuh
                });
            }
            
            if (searchForm) searchForm.addEventListener('submit', (e) => e.preventDefault());
        }

        // [DIUBAH] Diringkaskan, hanya untuk scroll
        function setupEventListeners(){
            // [BARU] Listener untuk infinite scroll
            window.addEventListener('scroll', handleScroll);
        }
        
        // [BARU] Fungsi Scroll handler
        function handleScroll() {
            // Jangan muat lebih banyak jika sedang mencari atau sudah memuat
            if (isSearching || isLoadingMore) return;

            // Cek jika sudah scroll dekat ke bawah (500px dari bawah)
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
                renderMoreContent();
            }
        }

        // [DIHAPUS] Semua fungsi modal video/episode:
        // closeVideoModal()
        // formatDuration()
        // openEpisodeList()
        // playVideoInModal()

        // [DIUBAH] Fungsi renderContent diubah menjadi renderMoreContent untuk infinite scroll
        function renderMoreContent() {
            if (isLoadingMore) return; // Mencegah pemuatan ganda
            isLoadingMore = true;

            // Tentukan batas berdasarkan data yang sedang ditampilkan (filter atau semua)
            const dataToRender = isSearching ? filteredSeriesContent : allSeriesContent;
            const limit = window.innerWidth < 768 ? MOBILE_LIMIT : DESKTOP_LIMIT;
            
            const newItems = dataToRender.slice(currentDisplayCount, currentDisplayCount + limit);
            
            if (newItems.length === 0) {
                if (currentDisplayCount === 0) {
                    contentListEl.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">Tidak ada konten ditemukan.</p>';
                }
                // Jika tidak ada item baru, berarti sudah di akhir. Tidak perlu apa-apa.
                isLoadingMore = false;
                return;
            }
            
            newItems.forEach(itemData => {
                const itemEl = document.createElement('div');
                itemEl.className = 'content-card bg-gray-800 bg-opacity-50 rounded-lg overflow-hidden shadow-lg transform hover:-translate-y-1';
                
                // [DIUBAH] Klik kini mengarahkan ke watch.html
                itemEl.innerHTML = `
                    <a href="watch.html?id=${itemData.id}">
                        <div class="relative w-full aspect-[7/9] bg-black">
                            <img src="${itemData.data.thumbnailUrl}" alt="${itemData.data.title}" class="w-full h-full object-cover">
                        </div>
                        <div class="p-4 space-y-1 text-left">
                            <h4 class="font-semibold text-white leading-tight truncate text-xs" title="${itemData.data.title}">${itemData.data.title}</h4>
                            <div class="flex items-center justify-between mt-1"> 
                                <div class="flex items-center text-[9px] text-yellow-400">
                                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                    <span>${(itemData.data.rating || 'N/A').replace(' / 10', '')}</span>
                                </div>
                                
                                <div class="flex items-center text-[9px] text-gray-400">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                                    <span>${(itemData.data.episodeCount || 0)} Eps</span>
                                </div>
                                <!-- [BARU] Total Penonton -->
                                <div class="flex items-center text-[9px] text-gray-400">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                    <span>${(itemData.data.viewCount || 0).toLocaleString('id-ID')}</span>
                                </div>
                            </div>
                        </div>
                    </a>`;
                // [DIUBAH] Event listener kini di dalam elemen 'a' (anchor)
                // itemEl.addEventListener('click', () => openEpisodeList(itemData.id, itemData.data));
                contentListEl.appendChild(itemEl);
            });

            currentDisplayCount += newItems.length; // Update hitungan
            isLoadingMore = false; // Buka kunci
        }
        
        // --- [DIHAPUS] FUNGSI AUTOSAVE (dipindahkan ke watch.html) ---
        // getWatchProgress()
        // saveWatchProgress()
        // setupVideoProgressSaving()

        // --- FUNGSI BARU UNTUK VISITOR & VIEWS ---
        
        async function logPageView() {
            try {
                // Gunakan localStorage untuk memastikan pengunjung unik per perangkat
                const hasVisited = localStorage.getItem('aisnimeVisited');
                if (!hasVisited) {
                    const statsRef = doc(db, 'settings', 'analytics');
                    await setDoc(statsRef, {
                        uniqueVisitors: increment(1)
                    }, { merge: true });
                    localStorage.setItem('aisnimeVisited', 'true');
                }
            } catch (error) {
                console.error("Gagal mencatat kunjungan unik:", error);
            }
        }
        
        // [DIHAPUS] logVideoPlay() (dipindahkan ke watch.html)
        
        // --- [BARU] FUNGSI CHAT ---
        function setupChat() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            chatCollRef = collection(db, 'artifacts', appId, 'public', 'data', 'chat');
            
            const chatContainer = document.getElementById('chat-container');
            const chatOverlay = document.getElementById('chat-overlay');
            const openChatBtn = document.getElementById('open-chat-btn');
            const closeChatBtn = document.getElementById('close-chat-btn');
            
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const chatMessagesEl = document.getElementById('chat-messages');

            const toggleChat = (open) => {
                if (open) {
                    chatContainer.classList.remove('translate-x-full');
                    chatOverlay.classList.remove('hidden');
                } else {
                    chatContainer.classList.add('translate-x-full');
                    chatOverlay.classList.add('hidden');
                }
            };

            openChatBtn.addEventListener('click', () => toggleChat(true));
            closeChatBtn.addEventListener('click', () => toggleChat(false));
            chatOverlay.addEventListener('click', () => toggleChat(false));
            
            // Listener untuk kirim pesan
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const message = chatInput.value.trim();
                if (message && currentUserId) {
                    try {
                        addDoc(chatCollRef, {
                            text: message,
                            userId: currentUserId, // Simpan ID untuk identifikasi
                            createdAt: Timestamp.now()
                        });
                        chatInput.value = '';
                    } catch (error) {
                        console.error("Gagal mengirim pesan:", error);
                    }
                }
            });
            
            // Listener untuk pesan baru
            const q = query(chatCollRef, orderBy("createdAt", "desc"), limit(100)); // [DIUBAH] limit(100)
            
            if (chatUnsubscribe) chatUnsubscribe(); // Hentikan listener lama jika ada
            
            chatUnsubscribe = onSnapshot(q, (snapshot) => {
                chatMessagesEl.innerHTML = ''; // Kosongkan
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push(doc.data());
                });

                // Balikkan urutan agar pesan terbaru di bawah
                messages.reverse().forEach(msg => {
                    const isMe = msg.userId === currentUserId;
                    const msgEl = document.createElement('div');
                    msgEl.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'}`;
                    
                    msgEl.innerHTML = `
                        <span class="text-xs text-gray-400 mb-1 ${isMe ? 'mr-2' : 'ml-2'}">
                            ${msg.userId.substring(0, 6)}...
                        </span>
                        <div class="max-w-[80%] break-words p-3 rounded-lg ${isMe ? 'bg-purple-600 text-white' : 'bg-gray-700 text-white'}">
                            <p class="text-sm">${msg.text}</p>
                        </div>
                    `;
                    chatMessagesEl.appendChild(msgEl);
                });
                
                // Auto-scroll ke bawah
                chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
            });
        }

        // Menunggu sehingga DOM sedia sebelum menjalankan 'main'
        window.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>

