<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halaman Admin - Manajemen Konten</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- [BARU] Tambahkan Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .menu-btn { border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .menu-btn.active-menu { border-bottom-color: #8B5CF6; color: white; }
        .search-result-item:hover { background-color: #374151; }
        .episode-list-item:hover { background-color: #374151; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto p-4 lg:p-8 max-w-4xl">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-white">Panel Admin</h1>
            <p class="text-lg text-gray-400 mt-2">Kelola Serial dan Episode Anda</p>
        </header>

        <div class="mb-8 flex justify-center border-b border-gray-700">
             <button id="show-manage-view-btn" class="menu-btn py-4 px-6 font-semibold text-gray-400">Kelola Serial</button>
             <button id="show-add-serial-view-btn" class="menu-btn py-4 px-6 font-semibold text-gray-400">Tambah Serial (API)</button>
             <button id="show-auto-upload-view-btn" class="menu-btn py-4 px-6 font-semibold text-gray-400">Auto Upload Folder</button>
             <button id="show-detail-view-btn" class="menu-btn py-4 px-6 font-semibold text-gray-400">Detail</button>
            <button id="show-settings-view-btn" class="menu-btn py-4 px-6 font-semibold text-gray-400">Setting</button>
        </div>
        
        <div id="views-container">
            <div id="manage-content-view">
                 <div class="bg-gray-800 p-8 rounded-lg shadow-2xl">
                    <h2 class="text-2xl font-bold mb-6">Kelola Serial Anime</h2>
                    <div id="series-list-container" class="space-y-4">
                        <p id="content-list-loading" class="text-gray-400">Memuat daftar serial...</p>
                    </div>
                </div>
            </div>

            <div id="auto-upload-view" class="hidden">
                <div class="bg-gray-800 p-8 rounded-lg shadow-2xl">
                    <h2 class="text-2xl font-bold text-center mb-6">Auto Upload Folder (API + Video)</h2>
                    <p class="text-gray-400 text-center mb-6">Pilih folder. Nama folder akan dicari di API untuk membuat serial baru, dan semua video di dalamnya akan diunggah sebagai episode.</p>
                    <div class="mt-6 space-y-4">
                        <div>
                            <label for="auto-upload-folder-input" class="block text-sm font-medium text-gray-300 mb-1">Pilih Folder Video</label>
                            <input type="file" id="auto-upload-folder-input" webkitdirectory directory multiple class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700">
                        </div>
                        <div id="auto-upload-progress-container" class="mt-4 space-y-2 hidden">
                             <div id="auto-upload-progress-bar" class="w-full bg-gray-700 rounded-full h-2.5">
                                <div class="bg-blue-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                             </div>
                             <p id="auto-upload-progress-text" class="text-center text-sm min-h-[20px]"></p>
                             <!-- Log Progres (BARU) -->
                             <div class="mt-2">
                                <label for="auto-upload-log" class="block text-sm font-medium text-gray-300 mb-1">Log Progres:</label>
                                <textarea id="auto-upload-log" rows="10" class="w-full bg-gray-900 text-gray-300 text-xs rounded-md p-3" readonly></textarea>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAMPILAN DETAIL BARU -->
            <div id="detail-view" class="hidden">
                <div class="bg-gray-800 p-8 rounded-lg shadow-2xl">
                    <h2 class="text-2xl font-bold mb-6 text-center">Detail & Statistik</h2>
                    
                    <!-- Statistik Pengunjung -->
                    <div class="mb-8 border-b border-gray-700 pb-8">
                        <h3 class="text-xl font-semibold mb-4">Statistik Pengunjung</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <p class="text-sm text-gray-400">Total Pengunjung Unik</p>
                                <p id="stats-total-visitors" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <p class="text-sm text-gray-400">Total Video Ditonton</p>
                                <p id="stats-total-views" class="text-3xl font-bold">0</p>
                            </div>
                        </div>
                        <div class="mt-4" style="max-height: 300px;">
                             <canvas id="visitors-chart"></canvas>
                        </div>
                    </div>

                    <!-- Statistik Serial -->
                    <div class="mb-8 border-b border-gray-700 pb-8">
                        <h3 class="text-xl font-semibold mb-4">Serial Paling Populer (Top 5)</h3>
                        <div style="max-height: 400px;">
                            <canvas id="series-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Cloudinary Usage (Disederhanakan) -->
                    <div class="mb-8 border-b border-gray-700 pb-8">
                        <h3 class="text-xl font-semibold mb-4">Cloudinary</h3>
                         <p class="text-gray-400 text-sm">Untuk melihat penggunaan penyimpanan (storage) dan bandwidth (transformations), silakan klik tombol di bawah untuk membuka dasbor Cloudinary Anda.</p>
                        <a href="https://cloudinary.com/console" target="_blank" class="block w-full text-center mt-6 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition">
                            Buka Dasbor Cloudinary
                        </a>
                    </div>
                    
                    <!-- Firebase Usage (Placeholder) -->
                    <div>
                         <h3 class="text-xl font-semibold mb-4">Firebase (Firestore)</h3>
                         <p class="text-gray-400 text-sm">Untuk saat ini, silakan periksa penggunaan Firestore dan Storage langsung di Firebase Console Anda.</p>
                         <a href="https://console.firebase.google.com/" target="_blank" class="block w-full text-center mt-6 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition">
                            Buka Firebase Console
                        </a>
                    </div>
                </div>
            </div>

            <div id="settings-view" class="hidden">
                  <div class="bg-gray-800 p-8 rounded-lg shadow-2xl space-y-8">
                     
                     <!-- [BARU] Pengaturan Tampilan Situs -->
                     <div class="border-b border-gray-700 pb-6 space-y-4">
                        <h3 class="text-2xl font-bold text-center">Pengaturan Tampilan Situs</h3>
                        <!-- Favicon -->
                        <div class="flex items-center space-x-4">
                            <img id="faviconPreview" src="https://placehold.co/32x32/374151/FFF?text=Icon" alt="Favicon Preview" class="w-8 h-8 rounded">
                            <div class="flex-1">
                                <label for="favicon-file" class="block text-sm font-medium text-gray-300 mb-1">Icon (Favicon)</label>
                                <input type="file" id="favicon-file" accept="image/png, image/x-icon, image/jpeg" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:font-semibold file:bg-gray-600 file:text-white hover:file:bg-gray-700">
                            </div>
                        </div>
                        <!-- Logo Utama -->
                        <div class="flex items-center space-x-4">
                             <img id="mainLogoPreview" src="https://placehold.co/100x50/374151/FFF?text=Logo" alt="Logo Preview" class="w-24 h-12 object-contain rounded bg-gray-700">
                            <div class="flex-1">
                                <label for="mainLogo-file" class="block text-sm font-medium text-gray-300 mb-1">Logo Utama (Header)</label>
                                <input type="file" id="mainLogo-file" accept="image/png, image/jpeg, image/svg+xml" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:font-semibold file:bg-gray-600 file:text-white hover:file:bg-gray-700">
                            </div>
                        </div>
                        <!-- Background -->
                        <div class="flex items-center space-x-4">
                            <img id="backgroundPreview" src="https://placehold.co/100x50/374151/FFF?text=BG" alt="Background Preview" class="w-24 h-12 object-cover rounded">
                            <div class="flex-1">
                                <label for="background-file" class="block text-sm font-medium text-gray-300 mb-1">Gambar Latar (Background)</label>
                                <input type="file" id="background-file" accept="image/png, image/jpeg, image/webp" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:font-semibold file:bg-gray-600 file:text-white hover:file:bg-gray-700">
                            </div>
                        </div>
                        <button type="button" id="save-display-btn" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition">Simpan Pengaturan Tampilan</button>
                        <p id="display-status-message" class="text-center text-sm min-h-[20px] mt-2"></p>
                     </div>
                     
                     <!-- [DIUBAH] Menggabungkan Cloudinary & Gemini -->
                     <div class="border-b border-gray-700 pb-6 space-y-4">
                        <h3 class="text-2xl font-bold text-center">Konfigurasi API</h3>
                        <!-- Cloudinary -->
                        <div>
                            <input type="text" id="cloudinary-cloud-name" class="w-full bg-gray-700 rounded-md p-3" placeholder="Cloudinary Cloud Name (Dari dasbor Anda)">
                        </div>
                        <div>
                            <input type="text" id="cloudinary-upload-preset" class="w-full bg-gray-700 rounded-md p-3" placeholder="Cloudinary Upload Preset Name (Unsigned)">
                        </div>
                        <button type="button" id="test-cloudinary-btn" class="w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition">Tes Koneksi Cloudinary</button>
                        <p id="cloudinary-test-status" class="text-center text-sm min-h-[20px] mt-2"></p>
                        
                        <!-- Gemini -->
                        <div class="pt-4">
                            <input type="password" id="gemini-api-key" class="w-full bg-gray-700 rounded-md p-3" placeholder="Gemini API Key (Dari Google AI Studio)">
                        </div>
                    </div>

                    <!-- [DIUBAH] Batas Paket (Label di dalam) -->
                    <div class="border-b border-gray-700 pb-6 space-y-4">
                        <h3 class="text-2xl font-bold text-center">Batas Paket (untuk Tampilan Detail)</h3>
                        <div>
                            <input type="number" id="limit-storage" class="w-full bg-gray-700 rounded-md p-3" placeholder="Total Penyimpanan (GB) (cth: 25)">
                        </div>
                        <div>
                            <input type="number" id="limit-bandwidth" class="w-full bg-gray-700 rounded-md p-3" placeholder="Total Transformasi/Bandwidth (GB) (cth: 50)">
                        </div>
                    </div>
                    
                     <button type="button" id="save-creds-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition">Simpan Semua Konfigurasi</button>
                     <p id="creds-status-message" class="text-center text-sm min-h-[20px]"></p>
                </div>
            </div>
            <div id="add-serial-view" class="hidden">
                <div class="bg-gray-800 p-8 rounded-lg shadow-2xl">
                    <h2 class="text-2xl font-bold text-center mb-6">Tambah Serial Baru dari MyAnimeList (Tanpa Video)</h2>
                    <div class="space-y-4">
                        <label for="jikan-search-input" class="block text-sm font-medium text-gray-300">Cari Judul Anime</label>
                        <input type="text" id="jikan-search-input" placeholder="Ketik untuk mencari otomatis..." class="w-full bg-gray-700 rounded-md p-3">
                    </div>
                    <div id="jikan-results-container" class="mt-6 space-y-2 max-h-60 overflow-y-auto"></div>
                    <form id="auto-upload-form" class="hidden mt-6 border-t border-gray-700 pt-6 space-y-6">
                        <h3 class="text-xl font-bold">Data Serial Terpilih:</h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Thumbnail</label>
                            <img id="auto-thumbnail-preview" src="" class="w-24 h-32 object-cover rounded-md border-2 border-gray-600">
                        </div>
                        <input type="text" id="auto-title" class="w-full bg-gray-600 rounded-md p-3" readonly>
                        <textarea id="auto-description" rows="5" class="w-full bg-gray-600 rounded-md p-3" readonly></textarea>
                        <input type="text" id="auto-genre" class="w-full bg-gray-600 rounded-md p-3" readonly>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div><label for="auto-rating" class="block text-sm font-medium">Rating</label><input type="text" id="auto-rating" class="w-full bg-gray-600 rounded-md p-3" readonly></div>
                            <div><label for="auto-scored_by" class="block text-sm font-medium">Jml Vote</label><input type="text" id="auto-scored_by" class="w-full bg-gray-600 rounded-md p-3" readonly></div>
                            <div><label for="auto-members" class="block text-sm font-medium">Anggota</label><input type="text" id="auto-members" class="w-full bg-gray-600 rounded-md p-3" readonly></div>
                            <div><label for="auto-aired" class="block text-sm font-medium">Rilis</label><input type="text" id="auto-aired" class="w-full bg-gray-600 rounded-md p-3" readonly></div>
                        </div>
                        <input type="hidden" id="auto-thumbnail-url">
                        <div><button type="button" id="save-auto-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition">Simpan Serial ke Database</button></div>
                        <p id="auto-status-message" class="text-center text-sm min-h-[20px]"></p>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL TAMBAH EPISODE -->
    <div id="add-episode-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
       <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-2xl space-y-6">
             <h2 class="text-2xl font-bold">Tambah Episode Baru untuk <span id="episode-series-title" class="text-purple-400"></span></h2>
             <form id="add-episode-form">
                 <input type="hidden" id="episode-series-id">
                 <div class="mt-4"><label for="episode-number" class="block text-sm font-medium">Nomor Episode</label><input type="number" id="episode-number" class="w-full bg-gray-700 rounded-md p-3 mt-1" placeholder="Contoh: 1"></div>
                 <div class="mt-4"><label for="episode-title" class="block text-sm font-medium">Judul Episode (Opsional)</label><input type="text" id="episode-title" class="w-full bg-gray-700 rounded-md p-3 mt-1" placeholder="Contoh: Kedatangan Sang Penyihir"></div>
                 <div class="mt-4"><label for="episode-video-file" class="block text-sm font-medium">File Video (Resolusi Tertinggi)</label><input type="file" id="episode-video-file" accept="video/*" class="w-full text-sm mt-1 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-gray-600 file:text-white"></div>
                 <p id="episode-status-message" class="text-center text-sm min-h-[20px] mt-4"></p>
                 <div class="flex justify-end space-x-4 pt-6"><button type="button" id="cancel-episode-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Batal</button><button type="button" id="save-episode-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Simpan Episode</button></div>
             </form>
        </div>
    </div>

    <!-- MODAL UPDATE SERIAL -->
    <div id="update-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
       <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-2xl space-y-6 max-h-screen overflow-y-auto">
             <h2 class="text-2xl font-bold">Ubah Detail Serial</h2>
             <div class="border-b border-gray-700 pb-6 space-y-2">
                <label for="update-jikan-search" class="block text-sm font-medium">Cari Ulang Data dari MyAnimeList (Opsional)</label>
                <input type="text" id="update-jikan-search" class="w-full bg-gray-700 rounded-md p-2" placeholder="Ketik judul baru untuk mencari...">
                <div id="update-jikan-results" class="mt-2 max-h-40 overflow-y-auto"></div>
            </div>
             <div><label for="update-title" class="block text-sm font-medium">Judul</label><input type="text" id="update-title" class="w-full bg-gray-700 rounded-md p-3 mt-1"></div>
             <div><label for="update-thumbnail-url" class="block text-sm font-medium">URL Thumbnail</label><input type="text" id="update-thumbnail-url" class="w-full bg-gray-700 rounded-md p-3 mt-1"></div>
             <div><label for="update-description" class="block text-sm font-medium">Deskripsi</label><textarea id="update-description" rows="4" class="w-full bg-gray-700 rounded-md p-3 mt-1"></textarea></div>
             <div><label for="update-genre" class="block text-sm font-medium">Genre</label><input type="text" id="update-genre" class="w-full bg-gray-700 rounded-md p-3 mt-1"></div>
             <div class="grid grid-cols-3 gap-4">
                <div><label for="update-rating" class="block text-sm font-medium">Rating</label><input type="text" id="update-rating" class="w-full bg-gray-700 rounded-md p-3 mt-1"></div>
                <div><label for="update-scored_by" class="block text-sm font-medium">Jumlah Vote</label><input type="text" id="update-scored_by" class="w-full bg-gray-700 rounded-md p-3 mt-1"></div>
                <div><label for="update-members" class="block text-sm font-medium">Anggota</label><input type="text" id="update-members" class="w-full bg-gray-700 rounded-md p-3 mt-1"></div>
             </div>
             <div class="flex justify-end space-x-4 pt-6"><button id="cancel-update-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Batal</button><button id="save-update-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Simpan</button></div>
        </div>
    </div>
    
    <!-- MODAL LIHAT/EDIT EPISODE -->
    <div id="episode-list-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
       <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-3xl space-y-6 max-h-[90vh] flex flex-col">
           <div class="flex justify-between items-center">
               <h2 class="text-2xl font-bold">Daftar Episode untuk <span id="list-series-title" class="text-purple-400"></span></h2>
               <button id="close-episode-list-btn" class="text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
           </div>
           <div id="episode-list-container" class="flex-grow overflow-y-auto space-y-3">
               <!-- Daftar episode akan dimuat di sini -->
           </div>
       </div>
    </div>

    <!-- MODAL UPDATE EPISODE -->
    <div id="update-episode-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
       <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-2xl space-y-6">
             <h2 class="text-2xl font-bold">Ubah Detail Episode</h2>
             <form id="update-episode-form">
                 <input type="hidden" id="update-episode-series-id">
                 <input type="hidden" id="update-episode-id">
                 <div class="mt-4"><label for="update-episode-number" class="block text-sm font-medium">Nomor Episode</label><input type="number" id="update-episode-number" class="w-full bg-gray-700 rounded-md p-3 mt-1"></div>
                 <div class="mt-4"><label for="update-episode-title" class="block text-sm font-medium">Judul Episode</label><input type="text" id="update-episode-title" class="w-full bg-gray-700 rounded-md p-3 mt-1"></div>
                 <div class="mt-4"><label for="update-episode-duration" class="block text-sm font-medium">Durasi (JJ:MM:DD)</label><input type="text" id="update-episode-duration" class="w-full bg-gray-700 rounded-md p-3 mt-1" placeholder="JJ:MM:DD"></div>
                 <p class="text-xs text-gray-400 mt-2">Untuk mengubah file video, hapus episode ini dan unggah kembali.</p>
                 <p id="update-episode-status-message" class="text-center text-sm min-h-[20px] mt-4"></p>
                 <div class="flex justify-end space-x-4 pt-6">
                     <button type="button" id="cancel-update-episode-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Batal</button>
                     <button type="button" id="save-update-episode-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Update Episode</button>
                 </div>
             </form>
        </div>
    </div>
    
    <script type="module">
        import { auth, db, seriesCollRef, settingsCollRef } from 'https://aisnime.github.io/firebase-init.js';
        import { signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { collection, addDoc, Timestamp, query, orderBy, onSnapshot, doc, getDoc, getDocs, updateDoc, deleteDoc, setDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const JIKAN_API_BASE = "https://api.jikan.moe/v4";
        let cloudinaryConfig = { cloudName: '', uploadPreset: '' };
        let geminiApiKey = ''; 

        // --- FUNGSI UPLOAD BARU DENGAN XHR ---
        function uploadToCloudinary(file, progressCallback, resourceType = 'video') { // [DIUBAH] Tambah resourceType
            return new Promise((resolve, reject) => {
                if (!cloudinaryConfig.cloudName || !cloudinaryConfig.uploadPreset) {
                    return reject(new Error("Konfigurasi Cloudinary tidak ditemukan. Harap isi Cloud Name dan Upload Preset di menu 'Setting'."));
                }
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', cloudinaryConfig.uploadPreset);

                const xhr = new XMLHttpRequest();
                const url = `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/${resourceType}/upload`; // [DIUBAH] Gunakan resourceType
                
                let lastTime = Date.now();
                let lastLoaded = 0;

                xhr.upload.onprogress = (event) => {
                    if (event.lengthComputable && progressCallback) {
                        const currentTime = Date.now();
                        const timeDiff = (currentTime - lastTime) / 1000; // in seconds
                        
                        // Hanya update jika interval cukup besar untuk kalkulasi kecepatan
                        if (timeDiff > 0.5 || event.loaded === event.total) { 
                            const bytesLoaded = event.loaded - lastLoaded;
                            const speedBps = bytesLoaded / timeDiff; // Bytes per second
                            const speedMBps = (speedBps / 1024 / 1024).toFixed(2); // MB per second
                            
                            const percentComplete = (event.loaded / event.total) * 100;
                            const loadedMB = (event.loaded / 1024 / 1024).toFixed(2);
                            const totalMB = (event.total / 1024 / 1024).toFixed(2);

                            progressCallback(percentComplete, loadedMB, totalMB, `${speedMBps} MB/s`);
                            
                            lastTime = currentTime;
                            lastLoaded = event.loaded;
                        }
                    }
                };

                xhr.onload = () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        resolve(JSON.parse(xhr.responseText));
                    } else {
                        try {
                            const errorData = JSON.parse(xhr.responseText);
                            reject(new Error(`Cloudinary upload failed: ${errorData.error.message}`));
                        } catch (e) {
                            reject(new Error(`Cloudinary upload failed: Status ${xhr.status}`));
                        }
                    }
                };

                xhr.onerror = () => {
                    reject(new Error("Gagal fetch (Network error). Periksa koneksi internet Anda atau kredensial Cloudinary."));
                };

                xhr.open('POST', url, true);
                xhr.send(formData);
            });
        }
        
        function secondsToHHMMSS(seconds) {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        function HHMMSSToSeconds(str) {
            if (!str) return 0;
            const parts = str.split(':');
            if (parts.length !== 3) {
                console.warn(`Format durasi tidak valid: ${str}. Harusnya JJ:MM:DD`);
                return 0; 
            }
            const h = parseInt(parts[0], 10) || 0;
            const m = parseInt(parts[1], 10) || 0;
            const s = parseInt(parts[2], 10) || 0;
            return (h * 3600) + (m * 60) + s;
        }
        
        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}m ${secs}d`;
        }

        let manageView, addSerialView, settingsView, autoUploadView, detailView;
        let modal, addEpisodeModal, episodeListModal, updateEpisodeModal;
        let visitorChartInstance = null;
        let seriesChartInstance = null;
        
        async function main() {
             try {
                // Inisialisasi elemen DOM di dalam main
                manageView = document.getElementById('manage-content-view');
                addSerialView = document.getElementById('add-serial-view');
                settingsView = document.getElementById('settings-view');
                autoUploadView = document.getElementById('auto-upload-view'); 
                detailView = document.getElementById('detail-view'); 
                
                modal = document.getElementById('update-modal');
                addEpisodeModal = document.getElementById('add-episode-modal');
                episodeListModal = document.getElementById('episode-list-modal');
                updateEpisodeModal = document.getElementById('update-episode-modal');

                await signInAnonymously(auth);
                setupMenuNavigation();
                setupCredentialConfig();
                setupAddSerialView();
                setupAutoUploadView(); 
                setupDisplaySettings(); // [BARU] Panggil fungsi display settings
                setupEventListeners();
                renderSeriesList();
                loadDetailView(); // Panggil fungsi baru
            } catch (error) {
                console.error("Initialization failed:", error);
                document.body.innerHTML = `<div class="bg-red-900 text-white p-8">...Error...</div>`;
            }
        }
        
        function setupMenuNavigation() {
            const menuButtons = { 
                manage: document.getElementById('show-manage-view-btn'), 
                addSerial: document.getElementById('show-add-serial-view-btn'), 
                autoUpload: document.getElementById('show-auto-upload-view-btn'), 
                detail: document.getElementById('show-detail-view-btn'), // Baru
                settings: document.getElementById('show-settings-view-btn')
            };
            const views = { 
                manage: manageView, 
                addSerial: addSerialView, 
                autoUpload: autoUploadView, 
                detail: detailView, // Baru
                settings: settingsView
            };
            
            function switchView(viewName) {
                Object.keys(views).forEach(key => {
                    if(views[key]) views[key].classList.toggle('hidden', key !== viewName);
                    if(menuButtons[key]) menuButtons[key].classList.toggle('active-menu', key === viewName);
                });
                
                // [BARU] Muat statistik saat tab detail diklik
                if (viewName === 'detail') {
                    loadStatistics();
                }
            }
            
            menuButtons.manage.addEventListener('click', () => switchView('manage'));
            menuButtons.addSerial.addEventListener('click', () => switchView('addSerial'));
            menuButtons.autoUpload.addEventListener('click', () => switchView('autoUpload'));
            menuButtons.detail.addEventListener('click', () => switchView('detail')); // Baru
            menuButtons.settings.addEventListener('click', () => switchView('settings'));
            switchView('manage'); // Tampilan default
        }
        
        // --- FUNGSI BARU UNTUK UPLOAD GAMBAR TAMPILAN ---
        function setupDisplaySettings() {
            const faviconInput = document.getElementById('favicon-file');
            const logoInput = document.getElementById('mainLogo-file');
            const bgInput = document.getElementById('background-file');
            const saveBtn = document.getElementById('save-display-btn');
            const statusMsg = document.getElementById('display-status-message');
            
            const faviconPreview = document.getElementById('faviconPreview');
            const logoPreview = document.getElementById('mainLogoPreview');
            const bgPreview = document.getElementById('backgroundPreview');
            
            // Muat pratinjau saat ini
            const loadPreviews = async () => {
                const keys = ['favicon', 'mainLogo', 'background'];
                const previews = [faviconPreview, logoPreview, bgPreview];
                
                for (let i = 0; i < keys.length; i++) {
                    const docSnap = await getDoc(doc(settingsCollRef, keys[i]));
                    if (docSnap.exists() && docSnap.data().url) {
                        previews[i].src = docSnap.data().url;
                    }
                }
            };
            loadPreviews();
            
            saveBtn.addEventListener('click', async () => {
                saveBtn.disabled = true;
                statusMsg.textContent = "Memeriksa file...";
                
                const uploadPromises = [];
                
                if (faviconInput.files[0]) {
                    uploadPromises.push(uploadAndSaveSetting('favicon', faviconInput.files[0], faviconPreview));
                }
                if (logoInput.files[0]) {
                    uploadPromises.push(uploadAndSaveSetting('mainLogo', logoInput.files[0], logoPreview));
                }
                if (bgInput.files[0]) {
                    uploadPromises.push(uploadAndSaveSetting('background', bgInput.files[0], bgPreview));
                }

                if (uploadPromises.length === 0) {
                    statusMsg.textContent = "Tidak ada file yang dipilih.";
                    saveBtn.disabled = false;
                    return;
                }
                
                statusMsg.textContent = "Mengunggah gambar... (0%)";
                
                try {
                    await Promise.all(uploadPromises);
                    statusMsg.textContent = "Pengaturan tampilan berhasil disimpan!";
                } catch (error) {
                    statusMsg.textContent = `Error: ${error.message}`;
                } finally {
                    saveBtn.disabled = false;
                    // Kosongkan input file
                    faviconInput.value = '';
                    logoInput.value = '';
                    bgInput.value = '';
                    setTimeout(() => statusMsg.textContent = '', 4000);
                }
            });
        }
        
        async function uploadAndSaveSetting(key, file, previewElement) {
            const statusMsg = document.getElementById('display-status-message');
            
            // Definisikan progress callback sederhana untuk upload gambar
            const progressCallback = (percentComplete) => {
                 statusMsg.textContent = `Mengunggah ${key}... ${Math.round(percentComplete)}%`;
            };

            // Panggil uploadToCloudinary dengan 'image'
            const uploadResult = await uploadToCloudinary(file, progressCallback, 'image');
            
            const docRef = doc(settingsCollRef, key);
            await setDoc(docRef, { url: uploadResult.secure_url });
            
            // Update pratinjau
            if (previewElement) {
                previewElement.src = uploadResult.secure_url;
            }
        }
        // --- AKHIR FUNGSI TAMPILAN ---

        function setupCredentialConfig() {
            const cloudNameInput = document.getElementById('cloudinary-cloud-name');
            const uploadPresetInput = document.getElementById('cloudinary-upload-preset');
            const geminiApiKeyInput = document.getElementById('gemini-api-key');
            const saveCredsBtn = document.getElementById('save-creds-btn');
            const credsStatus = document.getElementById('creds-status-message');
            const testBtn = document.getElementById('test-cloudinary-btn');
            const testStatus = document.getElementById('cloudinary-test-status');

            // Input batas paket baru
            const limitStorageInput = document.getElementById('limit-storage');
            const limitBandwidthInput = document.getElementById('limit-bandwidth');

            const savedCloudinaryConfig = localStorage.getItem('cloudinaryConfig');
            if (savedCloudinaryConfig) {
                cloudinaryConfig = JSON.parse(savedCloudinaryConfig);
                cloudNameInput.value = cloudinaryConfig.cloudName;
                uploadPresetInput.value = cloudinaryConfig.uploadPreset;
            }
            
            const savedGeminiKey = localStorage.getItem('geminiApiKey');
            if (savedGeminiKey) {
                geminiApiKey = savedGeminiKey;
                geminiApiKeyInput.value = geminiApiKey;
            }
            
            // Muat batas paket yang tersimpan
            const savedLimits = localStorage.getItem('planLimits');
            if (savedLimits) {
                const limits = JSON.parse(savedLimits);
                limitStorageInput.value = limits.storage || '';
                limitBandwidthInput.value = limits.bandwidth || '';
            }

            saveCredsBtn.addEventListener('click', () => {
                cloudinaryConfig.cloudName = cloudNameInput.value.trim();
                cloudinaryConfig.uploadPreset = uploadPresetInput.value.trim();
                geminiApiKey = geminiApiKeyInput.value.trim();

                if (cloudinaryConfig.cloudName && cloudinaryConfig.uploadPreset) {
                    localStorage.setItem('cloudinaryConfig', JSON.stringify(cloudinaryConfig));
                } else {
                    alert('Harap isi Cloud Name dan Upload Preset Cloudinary.');
                    return;
                }
                 if (geminiApiKey) {
                     localStorage.setItem('geminiApiKey', geminiApiKey);
                } else {
                     // Dibuat opsional
                }
                
                // Simpan batas paket
                const limits = {
                    storage: limitStorageInput.value.trim(),
                    bandwidth: limitBandwidthInput.value.trim()
                };
                localStorage.setItem('planLimits', JSON.stringify(limits));
                
                credsStatus.textContent = "Konfigurasi berhasil disimpan!";
                alert('Konfigurasi berhasil disimpan.');
                loadDetailView(); // Perbarui tampilan detail
                setTimeout(() => credsStatus.textContent = '', 3000);
            });
            
            testBtn.addEventListener('click', testCloudinaryConnection);
        }
        
        function loadDetailView() {
            const storageBar = document.getElementById('storage-bar');
            const storageText = document.getElementById('storage-text');
            const bandwidthBar = document.getElementById('bandwidth-bar');
            const bandwidthText = document.getElementById('bandwidth-text');
            
            const savedLimits = localStorage.getItem('planLimits');
            if (savedLimits) {
                const limits = JSON.parse(savedLimits);
                const storageLimit = parseFloat(limits.storage) || 0;
                const bandwidthLimit = parseFloat(limits.bandwidth) || 0;

                if (storageLimit > 0) {
                    storageText.textContent = `Batas: ${storageLimit} GB (Penggunaan live tidak tersedia)`;
                    storageBar.style.width = '5%'; // Sekadar penanda visual
                    storageBar.classList.add('bg-gray-500'); // Tunjukkan ia tidak aktif
                } else {
                    storageText.textContent = "Batas belum diatur di Setting";
                    storageBar.style.width = '0%';
                }
                
                if (bandwidthLimit > 0) {
                    bandwidthText.textContent = `Batas: ${bandwidthLimit} GB (Penggunaan live tidak tersedia)`;
                    bandwidthBar.style.width = '5%'; // Sekadar penanda visual
                    bandwidthBar.classList.add('bg-gray-500');
                } else {
                    bandwidthText.textContent = "Batas belum diatur di Setting";
                    bandwidthBar.style.width = '0%';
                }
                
            } else {
                 storageText.textContent = "Batas belum diatur di Setting";
                 bandwidthText.textContent = "Batas belum diatur di Setting";
                 storageBar.style.width = '0%';
                 bandwidthBar.style.width = '0%';
            }
        }

        async function testCloudinaryConnection() {
            const cloudName = document.getElementById('cloudinary-cloud-name').value.trim();
            const uploadPreset = document.getElementById('cloudinary-upload-preset').value.trim();
            const statusEl = document.getElementById('cloudinary-test-status');

            if (!cloudName || !uploadPreset) {
                statusEl.textContent = "Harap isi Cloud Name dan Upload Preset.";
                statusEl.className = "text-center text-sm min-h-[20px] mt-2 text-red-400";
                return false; // Kembalikan false jika gagal
            }

            statusEl.textContent = "Mengetes koneksi...";
            statusEl.className = "text-center text-sm min-h-[20px] mt-2 text-yellow-400";

            // Data 1x1 pixel GIF transparan
            const testFile = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
            
            const formData = new FormData();
            formData.append('file', testFile);
            formData.append('upload_preset', uploadPreset);

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    statusEl.textContent = "Koneksi Berhasil! Kredensial valid.";
                    statusEl.className = "text-center text-sm min-h-[20px] mt-2 text-green-400";
                    return true; // Berhasil
                } else {
                    const errorData = await response.json();
                    statusEl.textContent = `Gagal: ${errorData.error.message}`;
                    statusEl.className = "text-center text-sm min-h-[20px] mt-2 text-red-400";
                    return false; // Gagal
                }
            } catch (error) {
                statusEl.textContent = `Gagal fetch: Periksa Cloud Name dan koneksi internet.`;
                statusEl.className = "text-center text-sm min-h-[20px] mt-2 text-red-400";
                return false; // Gagal
            }
        }
        
        // --- FUNGSI STATISTIK (BARU) ---
        async function loadStatistics() {
            // 1. Muat Statistik Umum
            try {
                const statsDoc = await getDoc(doc(db, 'settings', 'analytics'));
                let totalVisitors = 0;
                let totalViews = 0;
                
                if (statsDoc.exists()) {
                    totalVisitors = statsDoc.data().uniqueVisitors || 0;
                    totalViews = statsDoc.data().totalViews || 0;
                }
                
                document.getElementById('stats-total-visitors').textContent = totalVisitors.toLocaleString('id-ID');
                document.getElementById('stats-total-views').textContent = totalViews.toLocaleString('id-ID');
                
                renderVisitorChart(totalVisitors, totalViews);

            } catch (e) {
                console.error("Gagal memuat statistik pengunjung:", e);
            }

            // 2. Muat Statistik Serial (Top 5)
            try {
                const q = query(seriesCollRef, orderBy("viewCount", "desc"), limit(5));
                const snapshot = await getDocs(q);
                
                const labels = [];
                const data = [];
                
                snapshot.forEach(doc => {
                    labels.push(doc.data().title);
                    data.push(doc.data().viewCount || 0);
                });
                
                renderSeriesChart(labels, data);

            } catch (e) {
                console.error("Gagal memuat statistik serial:", e);
            }
        }
        
        function renderVisitorChart(visitors, views) {
            const ctx = document.getElementById('visitors-chart').getContext('2d');
            if (visitorChartInstance) {
                visitorChartInstance.destroy();
            }
            visitorChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pengunjung Unik', 'Total Tontonan'],
                    datasets: [{
                        label: 'Perbandingan',
                        data: [visitors, views],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                        ],
                        borderColor: [
                            '#374151',
                            '#374151'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#D1D5DB' }
                        }
                    }
                }
            });
        }
        
        function renderSeriesChart(labels, data) {
            const ctx = document.getElementById('series-chart').getContext('2d');
            if (seriesChartInstance) {
                seriesChartInstance.destroy();
            }
            seriesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Ditonton',
                        data: data,
                        backgroundColor: 'rgba(139, 92, 246, 0.8)',
                        borderColor: 'rgba(139, 92, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // Membuatnya jadi bar horizontal
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: { color: '#D1D5DB' },
                            grid: { color: '#4B5563' }
                        },
                        y: {
                            ticks: { color: '#D1D5DB' },
                            grid: { color: '#4B5563' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        // --- AKHIR FUNGSI STATISTIK ---


        function renderSeriesList() {
             const seriesListContainer = document.getElementById('series-list-container');
             const q = query(seriesCollRef, orderBy("updatedAt", "desc")); // [DIKEMBALIKAN] Sort by updatedAt
             onSnapshot(q, (snapshot) => {
                 seriesListContainer.innerHTML = '';
                 if (snapshot.empty) {
                     seriesListContainer.innerHTML = '<p class="text-gray-400">Belum ada serial.</p>';
                     return;
                 }
                 snapshot.forEach(doc => {
                     const item = doc.data();
                     const itemEl = document.createElement('div');
                     itemEl.className = 'bg-gray-700 p-4 rounded-lg flex items-center justify-between';
                     itemEl.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <img src="${item.thumbnailUrl}" alt="thumbnail" class="w-12 h-16 object-cover rounded-md bg-gray-600">
                            <div><h3 class="font-semibold text-white">${item.title}</h3></div>
                        </div>
                        <div class="space-x-2">
                             <button data-id="${doc.id}" class="update-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md text-sm">Ubah Serial</button>
                             <button data-series-id="${doc.id}" data-series-title="${item.title}" class="list-episodes-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md text-sm">Lihat Episode</button>
                             <button data-series-id="${doc.id}" data-series-title="${item.title}" class="add-episode-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md text-sm">Tambah Episode</button>
                             <button data-id="${doc.id}" class="delete-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md text-sm">Hapus</button>
                        </div>`;
                     seriesListContainer.appendChild(itemEl);
                 });
             });
        }
        
        function setupAddSerialView() {
            let selectedAnimeData = null;
            let debounceTimeout;
            const searchInput = document.getElementById('jikan-search-input');
            const resultsContainer = document.getElementById('jikan-results-container');
            const uploadForm = document.getElementById('auto-upload-form');
            const saveAutoBtn = document.getElementById('save-auto-button');
            const autoStatus = document.getElementById('auto-status-message');
            const thumbPreview = document.getElementById('auto-thumbnail-preview');
            
            searchInput.addEventListener('input', () => {
                clearTimeout(debounceTimeout);
                const query = searchInput.value.trim();
                if (query.length < 3) { resultsContainer.innerHTML = ''; return; }
                resultsContainer.innerHTML = `<p class="text-center">Mencari...</p>`;
                debounceTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`${JIKAN_API_BASE}/anime?q=${encodeURIComponent(query)}&limit=5`);
                        const data = await response.json();
                        resultsContainer.innerHTML = '';
                        if (data.data && data.data.length > 0) {
                            data.data.forEach(anime => {
                                const itemEl = document.createElement('div');
                                itemEl.className = 'search-result-item flex items-center space-x-4 p-2 rounded-md cursor-pointer';
                                itemEl.innerHTML = `<img src="${anime.images.jpg.small_image_url}" class="w-12 h-16 object-cover rounded"><div><h4 class="font-semibold">${anime.title}</h4><p class="text-sm text-gray-400">${anime.year || 'N/A'}</p></div>`;
                                itemEl.addEventListener('click', () => selectAnime(anime));
                                resultsContainer.appendChild(itemEl);
                            });
                        } else {
                            resultsContainer.innerHTML = `<p class="text-center">Tidak ada hasil ditemukan.</p>`;
                        }
                    } catch (error) {
                        resultsContainer.innerHTML = `<p class="text-center text-red-400">Gagal mencari.</p>`;
                    }
                }, 500);
            });
            
            function selectAnime(anime) {
                selectedAnimeData = anime;
                resultsContainer.innerHTML = '';
                uploadForm.classList.remove('hidden');
                document.getElementById('auto-title').value = anime.title;
                document.getElementById('auto-description').value = anime.synopsis || 'Tidak ada sinopsis.';
                document.getElementById('auto-genre').value = anime.genres.map(g => g.name).join(', ');
                document.getElementById('auto-rating').value = anime.score ? `${anime.score} / 10` : 'N/A';
                document.getElementById('auto-scored_by').value = (anime.scored_by || 0).toLocaleString('id-ID');
                document.getElementById('auto-members').value = (anime.members || 0).toLocaleString('id-ID');
                document.getElementById('auto-aired').value = anime.aired.string || 'N/A';
                const thumbnailUrl = anime.images.jpg.large_image_url;
                document.getElementById('auto-thumbnail-url').value = thumbnailUrl;
                thumbPreview.src = thumbnailUrl;
            }

            saveAutoBtn.addEventListener('click', async () => {
                autoStatus.textContent = "Menyimpan data serial...";
                saveAutoBtn.disabled = true;
                try {
                    await addDoc(seriesCollRef, {
                        title: document.getElementById('auto-title').value,
                        description: document.getElementById('auto-description').value,
                        genre: document.getElementById('auto-genre').value.split(',').map(g => g.trim()),
                        rating: document.getElementById('auto-rating').value,
                        members: selectedAnimeData.members || 0,
                        scored_by: selectedAnimeData.scored_by || 0,
                        thumbnailUrl: document.getElementById('auto-thumbnail-url').value,
                        releaseDate: selectedAnimeData.aired.string || 'N/A',
                        createdAt: Timestamp.now(),
                        updatedAt: Timestamp.now(), // [BARU] Tambahkan updatedAt saat membuat
                        episodeCount: 0,
                        viewCount: 0 // [BARU] Inisialisasi viewCount
                    });
                    autoStatus.textContent = "Serial berhasil disimpan!";
                    uploadForm.classList.add('hidden');
                    uploadForm.reset();
                    searchInput.value = '';
                } catch(error) {
                    autoStatus.textContent = `Error: ${error.message}`;
                } finally {
                    saveAutoBtn.disabled = false;
                    setTimeout(() => autoStatus.textContent = '', 5000);
                }
            });
        }
        
        function setupAutoUploadView() {
            const folderInput = document.getElementById('auto-upload-folder-input');
            const progressContainer = document.getElementById('auto-upload-progress-container');
            const progressBar = document.getElementById('auto-upload-progress-bar').querySelector('div');
            const progressText = document.getElementById('auto-upload-progress-text');
            const logEl = document.getElementById('auto-upload-log'); // Ambil log textarea

            // Fungsi helper untuk log
            function logProgress(message, percentage) {
                progressText.textContent = message.split('\n').pop(); // Hanya tampilkan baris terakhir di status
                logEl.value += `[${new Date().toLocaleTimeString()}] ${message}\n`; // Tambah ke log
                logEl.scrollTop = logEl.scrollHeight; // Auto-scroll
                if (percentage !== undefined) {
                    progressBar.style.width = `${percentage}%`;
                }
            }
            
            folderInput.addEventListener('change', async (event) => {
                // --- VALIDASI KREDENSIAL ---
                if (!cloudinaryConfig.cloudName || !cloudinaryConfig.uploadPreset) {
                    alert("Konfigurasi Cloudinary tidak ditemukan. Harap isi Cloud Name dan Upload Preset di menu 'Setting' terlebih dahulu.");
                    folderInput.value = ''; // Reset input
                    return;
                }
                
                progressContainer.classList.remove('hidden');
                folderInput.disabled = true;
                logEl.value = ''; // Kosongkan log
                
                // --- TES KONEKSI OTOMATIS (BARU) ---
                logProgress("Menguji koneksi Cloudinary...", 10);
                
                const testFormData = new FormData();
                testFormData.append('file', "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7");
                testFormData.append('upload_preset', cloudinaryConfig.uploadPreset);

                try {
                    const testResponse = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`, {
                        method: 'POST',
                        body: testFormData
                    });

                    if (!testResponse.ok) {
                        const errorData = await testResponse.json();
                        throw new Error(`Koneksi Gagal: ${errorData.error.message}`);
                    }
                } catch (error) {
                    logProgress(`Error: ${error.message}. Periksa 'Setting'.`, 0);
                    folderInput.disabled = false;
                    folderInput.value = '';
                    setTimeout(() => {
                        progressContainer.classList.add('hidden');
                        progressBar.style.width = '0%';
                    }, 7000);
                    return; // Hentikan proses jika tes gagal
                }
                // --- AKHIR TES KONEKSI ---

                const files = event.target.files;
                const videoFiles = Array.from(files).filter(f => f.type.startsWith('video/'));
                if (videoFiles.length === 0) {
                    alert("Tidak ada file video yang ditemukan di dalam folder.");
                    folderInput.disabled = false;
                    progressContainer.classList.add('hidden');
                    return;
                }
                
                // 1. Dapatkan nama folder dari file pertama
                const firstFile = videoFiles[0];
                const folderName = firstFile.webkitRelativePath.split('/')[0];
                logProgress(`Koneksi berhasil. Mencari serial untuk folder: "${folderName}"...`, 20);
                
                let seriesId = null;
                let seriesTitle = "";

                try {
                    // 2. Cari di Jikan API
                    const jikanResponse = await fetch(`${JIKAN_API_BASE}/anime?q=${encodeURIComponent(folderName)}&limit=1`);
                    const jikanData = await jikanResponse.json();
                    const animeData = jikanData.data[0];

                    if (!animeData) {
                        throw new Error(`Serial tidak ditemukan di MyAnimeList untuk: ${folderName}`);
                    }
                    
                    seriesTitle = animeData.title;
                    logProgress(`Serial ditemukan: "${seriesTitle}". Menyimpan serial...`, 30);

                    // 3. Simpan serial baru
                    const seriesRef = await addDoc(seriesCollRef, {
                        title: animeData.title,
                        description: animeData.synopsis || "",
                        genre: (animeData.genres || []).map(g => g.name),
                        rating: animeData.score ? `${animeData.score} / 10` : 'N/A',
                        members: animeData.members || 0,
                        scored_by: animeData.scored_by || 0,
                        thumbnailUrl: animeData.images.jpg.large_image_url,
                        releaseDate: animeData.aired.string || 'N/A',
                        createdAt: Timestamp.now(),
                        updatedAt: Timestamp.now(), // [BARU] Tambahkan updatedAt
                        episodeCount: 0,
                        viewCount: 0 // [BARU] Inisialisasi viewCount
                    });
                    seriesId = seriesRef.id;
                    logProgress(`Serial berhasil disimpan dengan ID: ${seriesId}`);

                } catch (e) {
                    logProgress(`Error: ${e.message}`, 0);
                    folderInput.disabled = false;
                    setTimeout(() => {
                        progressContainer.classList.add('hidden');
                        progressBar.style.width = '0%';
                    }, 5000);
                    return;
                }

                // 4. Loop dan upload setiap video
                let successCount = 0;
                let errorCount = 0;
                const episodeCollRef = collection(db, 'series', seriesId, 'episodes');

                for (let i = 0; i < videoFiles.length; i++) {
                    const file = videoFiles[i];
                    const progressStart = 30 + (i / videoFiles.length) * 60; // Progress awal untuk file ini
                    logProgress(`[${Math.round(progressStart)}%] [${i+1}/${videoFiles.length}] Mulai mengunggah: ${file.name}`, progressStart);

                    try {
                        const uploadResult = await uploadToCloudinary(file, (percentComplete, loadedMB, totalMB, speed) => {
                            // Update progress bar & log
                            const fileProgress = (percentComplete / 100) * (60 / videoFiles.length); // 60% dibagi rata
                            const totalProgress = progressStart + fileProgress;
                            logProgress(`[${Math.round(totalProgress)}%] [${i+1}/${videoFiles.length}] Mengunggah ${file.name}: ${loadedMB}MB / ${totalMB}MB (${speed})`, totalProgress);
                        }, 'video'); // Pastikan resourceType 'video'
                        
                        const baseUrl = uploadResult.secure_url.replace(/\/v\d+\//, '/');
                        const duration = Math.round(uploadResult.duration || 0); 
                        
                        const videoFilesDB = {
                            '1080p': baseUrl.replace('/upload/', `/upload/c_scale,h_1080/`),
                            '720p': baseUrl.replace('/upload/', `/upload/c_scale,h_720/`),
                            '480p': baseUrl.replace('/upload/', `/upload/c_scale,h_480/`)
                        };
                        
                        // Ekstrak info dari nama file
                        const fileName = file.name.replace(/\.[^/.]+$/, ""); // Hapus ekstensi
                        const episodeNumMatch = fileName.match(/^(?:.*[\[\s\._-])?(\d+)[\]\s\._-]*.*$/);
                        const episodeNumber = (episodeNumMatch && episodeNumMatch[1]) ? parseInt(episodeNumMatch[1]) : (i + 1);
                        const episodeTitle = fileName.replace(/\[.*?\]/g, '').replace(/\(.*?\)/g, '').replace(/ \d+p /i, ' ').replace(/^(\d+)[ ._-]*/, '').trim();

                        // Simpan ke sub-koleksi episode
                        await addDoc(episodeCollRef, {
                            episodeNumber: episodeNumber,
                            title: episodeTitle || `Episode ${episodeNumber}`,
                            videoFiles: videoFilesDB,
                            duration: duration,
                            publishAt: Timestamp.now()
                        });
                        logProgress(` -> BERHASIL: ${file.name}`);
                        successCount++;
                    } catch (error) {
                        console.error(`Gagal memproses file ${file.name}:`, error);
                        logProgress(` -> GAGAL: ${file.name}: ${error.message}`);
                        errorCount++;
                    }
                }
                
                // 5. Update hitungan episode
                if (successCount > 0) {
                     await updateDoc(doc(seriesCollRef, seriesId), {
                        episodeCount: successCount,
                        updatedAt: Timestamp.now() // [BARU] Perbarui updatedAt
                    });
                }

                logProgress(`Selesai! ${successCount} episode berhasil ditambahkan ke "${seriesTitle}". ${errorCount} gagal.`, 100);
                folderInput.value = ''; // Reset input
                folderInput.disabled = false;
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                    progressBar.style.width = '0%';
                }, 10000);
            });
        }
        
        function renderUnassignedVideos() {
            // Fungsi ini tidak lagi diperlukan
        }
        
        async function openUpdateModal(id) {
            const docRef = doc(seriesCollRef, id);
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) { alert("Konten tidak ditemukan."); return; }
            const item = docSnap.data();
            document.getElementById('update-title').value = item.title;
            document.getElementById('update-thumbnail-url').value = item.thumbnailUrl || '';
            document.getElementById('update-description').value = item.description || '';
            document.getElementById('update-genre').value = (item.genre || []).join(', ');
            document.getElementById('update-rating').value = item.rating || '';
            document.getElementById('update-scored_by').value = (item.scored_by || 0).toLocaleString('id-ID');
            document.getElementById('update-members').value = (item.members || 0).toLocaleString('id-ID');
            
            document.getElementById('save-update-button').dataset.id = id;
            modal.classList.remove('hidden');
        }

        async function saveContentUpdate() {
            const saveButton = document.getElementById('save-update-button');
            const id = saveButton.dataset.id;
            if (!id) return;
            saveButton.disabled = true;
            try {
                const docRef = doc(seriesCollRef, id); 
                               
                await updateDoc(docRef, {
                    title: document.getElementById('update-title').value.trim(),
                    thumbnailUrl: document.getElementById('update-thumbnail-url').value.trim(),
                    description: document.getElementById('update-description').value.trim(),
                    genre: document.getElementById('update-genre').value.split(',').map(g => g.trim()),
                    rating: document.getElementById('update-rating').value.trim(),
                    scored_by: parseInt(document.getElementById('update-scored_by').value.replace(/\./g, '')) || 0,
                    members: parseInt(document.getElementById('update-members').value.replace(/\./g, '')) || 0,
                    updatedAt: Timestamp.now() // [BARU] Perbarui updatedAt
                });
                modal.classList.add('hidden');
            } catch (error) {
                alert("Gagal menyimpan perubahan: " + error.message);
                console.error("Update error:", error);
            } finally {
                saveButton.disabled = false;
            }
        }

        async function openEpisodeListModal(seriesId, seriesTitle) {
            document.getElementById('list-series-title').textContent = seriesTitle;
            const container = document.getElementById('episode-list-container');
            container.innerHTML = '<p class="text-gray-400">Memuat episode...</p>';
            episodeListModal.classList.remove('hidden');

            const episodesCollRef = collection(db, 'series', seriesId, 'episodes');
            const q = query(episodesCollRef, orderBy("episodeNumber", "asc"));
            
            onSnapshot(q, (snapshot) => {
                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-400">Belum ada episode untuk serial ini.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const episode = doc.data();
                    const el = document.createElement('div');
                    el.className = "episode-list-item bg-gray-700 p-3 rounded-md flex justify-between items-center";
                    el.innerHTML = `
                        <div>
                            <span class="font-bold text-white">Ep. ${episode.episodeNumber}:</span>
                            <span class="text-gray-300 ml-2">${episode.title}</span>
                            <span class="text-xs text-gray-400 ml-4">(${formatDuration(episode.duration || 0)})</span>
                        </div>
                        <div class="space-x-2">
                            <button data-series-id="${seriesId}" data-episode-id="${doc.id}" class="edit-episode-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm">Edit</button>
                            <button data-series-id="${seriesId}" data-episode-id="${doc.id}" class="delete-episode-btn bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm">Hapus</button>
                        </div>
                    `;
                    container.appendChild(el);
                });
            });
        }

        function openUpdateEpisodeModal(seriesId, episodeId, episodeData) {
            document.getElementById('update-episode-series-id').value = seriesId;
            document.getElementById('update-episode-id').value = episodeId;
            document.getElementById('update-episode-number').value = episodeData.episodeNumber;
            document.getElementById('update-episode-title').value = episodeData.title;
            document.getElementById('update-episode-duration').value = secondsToHHMMSS(episodeData.duration || 0);
            updateEpisodeModal.classList.remove('hidden');
        }

        async function saveEpisodeUpdate() {
            const seriesId = document.getElementById('update-episode-series-id').value;
            const episodeId = document.getElementById('update-episode-id').value;
            const statusEl = document.getElementById('update-episode-status-message');
            const saveBtn = document.getElementById('save-update-episode-button');
            
            if (!seriesId || !episodeId) return;

            statusEl.textContent = "Menyimpan...";
            saveBtn.disabled = true;

            try {
                const episodeRef = doc(db, 'series', seriesId, 'episodes', episodeId);
                await updateDoc(episodeRef, {
                    episodeNumber: parseInt(document.getElementById('update-episode-number').value),
                    title: document.getElementById('update-episode-title').value.trim(),
                    duration: HHMMSSToSeconds(document.getElementById('update-episode-duration').value)
                });
                
                // [BARU] Perbarui updatedAt di serial induk
                const seriesRef = doc(db, 'series', seriesId);
                await updateDoc(seriesRef, { updatedAt: Timestamp.now() });

                statusEl.textContent = "Berhasil diperbarui!";
                setTimeout(() => {
                    updateEpisodeModal.classList.add('hidden');
                    statusEl.textContent = "";
                }, 1500);
            } catch(e) {
                statusEl.textContent = `Error: ${e.message}`;
            } finally {
                saveBtn.disabled = false;
            }
        }

        async function deleteEpisode(seriesId, episodeId) {
            try {
                await deleteDoc(doc(db, 'series', seriesId, 'episodes', episodeId));
                // Kurangi hitungan episode di dokumen serial
                const seriesRef = doc(db, 'series', seriesId);
                await updateDoc(seriesRef, {
                    episodeCount: increment(-1),
                    updatedAt: Timestamp.now() // [BARU] Perbarui updatedAt
                });
                alert('Episode berhasil dihapus.');
            } catch (e) {
                alert('Gagal menghapus episode.');
                console.error("Gagal menghapus episode: ", e);
            }
        }

        function setupEventListeners() {
            const seriesListContainer = document.getElementById('series-list-container');
            
            seriesListContainer.addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;
                
                if (target.classList.contains('update-btn')) {
                    openUpdateModal(id);
                }
                
                if (target.classList.contains('add-episode-btn')) {
                    const seriesId = target.dataset.seriesId;
                    const seriesTitle = target.dataset.seriesTitle;
                    document.getElementById('episode-series-id').value = seriesId;
                    document.getElementById('episode-series-title').textContent = seriesTitle;
                    addEpisodeModal.classList.remove('hidden');
                }
                
                if (target.classList.contains('list-episodes-btn')) {
                    openEpisodeListModal(target.dataset.seriesId, target.dataset.seriesTitle);
                }

                if (target.classList.contains('delete-btn')) {
                    if (confirm(`Apakah Anda yakin ingin menghapus serial ini beserta semua episodenya?`)) {
                        try {
                            await deleteDoc(doc(seriesCollRef, id));
                            alert('Serial berhasil dihapus.');
                        } catch (error) {
                            alert('Gagal menghapus serial.');
                        }
                    }
                }
            });
            
            // Hapus listener untuk 'unassignedListContainer'
            
            document.getElementById('cancel-episode-button').addEventListener('click', () => {
                addEpisodeModal.classList.add('hidden');
                document.getElementById('add-episode-form').reset();
            });

            document.getElementById('save-episode-button').addEventListener('click', saveNewEpisode);

            document.getElementById('cancel-update-button').addEventListener('click', () => modal.classList.add('hidden'));
            document.getElementById('save-update-button').addEventListener('click', saveContentUpdate);

            const updateSearchInput = document.getElementById('update-jikan-search');
            let updateDebounceTimeout;
            updateSearchInput.addEventListener('input', () => {
                clearTimeout(updateDebounceTimeout);
                const query = updateSearchInput.value.trim();
                const resultsContainer = document.getElementById('update-jikan-results');

                if (query.length < 3) {
                    resultsContainer.innerHTML = '';
                    return;
                }
                
                resultsContainer.innerHTML = `<p class="text-center text-sm">Mencari...</p>`;
                
                updateDebounceTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`${JIKAN_API_BASE}/anime?q=${encodeURIComponent(query)}&limit=3`);
                        const data = await response.json();
                        resultsContainer.innerHTML = '';
                        if (data.data && data.data.length > 0) {
                            data.data.forEach(anime => {
                                const itemEl = document.createElement('div');
                                itemEl.className = 'search-result-item flex items-center space-x-2 p-1 rounded-md cursor-pointer';
                                itemEl.innerHTML = `<img src="${anime.images.jpg.small_image_url}" class="w-8 h-10 object-cover rounded"><p class="text-sm">${anime.title}</p>`;
                                itemEl.addEventListener('click', () => selectAnimeForUpdate(anime));
                                resultsContainer.appendChild(itemEl);
                            });
                        } else {
                            resultsContainer.innerHTML = `<p class="text-center text-sm">Tidak ada hasil.</p>`;
                        }
                    } catch (error) {
                        resultsContainer.innerHTML = `<p class="text-center text-red-400 text-sm">Gagal mencari.</p>`;
                    }
                }, 500);
            });
            
            document.getElementById('close-episode-list-btn').addEventListener('click', () => {
                episodeListModal.classList.add('hidden');
            });

            document.getElementById('episode-list-container').addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                
                const seriesId = target.dataset.seriesId;
                const episodeId = target.dataset.episodeId;

                if (target.classList.contains('edit-episode-btn')) {
                    const episodeRef = doc(db, 'series', seriesId, 'episodes', episodeId);
                    const episodeSnap = await getDoc(episodeRef);
                    if(episodeSnap.exists()) {
                        openUpdateEpisodeModal(seriesId, episodeId, episodeSnap.data());
                    }
                }
                
                if (target.classList.contains('delete-episode-btn')) {
                     if (confirm(`Apakah Anda yakin ingin menghapus episode ini?`)) {
                        await deleteEpisode(seriesId, episodeId);
                     }
                }
            });

            document.getElementById('cancel-update-episode-button').addEventListener('click', () => {
                updateEpisodeModal.classList.add('hidden');
            });
            document.getElementById('save-update-episode-button').addEventListener('click', saveEpisodeUpdate);
        }

        function selectAnimeForUpdate(anime) {
            document.getElementById('update-jikan-results').innerHTML = '';
            document.getElementById('update-jikan-search').value = '';
            
            document.getElementById('update-title').value = anime.title;
            document.getElementById('update-thumbnail-url').value = anime.images.jpg.large_image_url;
            document.getElementById('update-description').value = anime.synopsis || 'Tidak ada sinopsis.';
            document.getElementById('update-genre').value = (anime.genres || []).map(g => g.name).join(', ');
            document.getElementById('update-rating').value = anime.score ? `${anime.score} / 10` : 'N/A';
            document.getElementById('update-scored_by').value = (anime.scored_by || 0).toLocaleString('id-ID');
            document.getElementById('update-members').value = (anime.members || 0).toLocaleString('id-ID');
        }

        async function saveNewEpisode() {
            const seriesId = document.getElementById('episode-series-id').value;
            const episodeNumber = document.getElementById('episode-number').value;
            const episodeTitle = document.getElementById('episode-title').value.trim();
            const videoFile = document.getElementById('episode-video-file').files[0];
            const statusEl = document.getElementById('episode-status-message');
            
            // --- VALIDASI KREDENSIAL ---
            if (!cloudinaryConfig.cloudName || !cloudinaryConfig.uploadPreset) {
                statusEl.textContent = "Konfigurasi Cloudinary tidak ditemukan di menu 'Setting'.";
                return;
            }
            // --- AKHIR VALIDASI ---

            if (!seriesId || !episodeNumber || !videoFile) {
                statusEl.textContent = "Nomor episode dan file video wajib diisi.";
                return;
            }

            statusEl.textContent = "Mengunggah video ke Cloudinary...";
            const saveBtn = document.getElementById('save-episode-button');
            saveBtn.disabled = true;

            const progressCallback = (percentComplete, loadedMB, totalMB, speed) => {
                const speedText = speed ? `(${speed})` : '';
                statusEl.textContent = `Mengunggah... ${Math.round(percentComplete)}% (${loadedMB}MB / ${totalMB}MB) ${speedText}`;
            };

            try {
                const uploadResult = await uploadToCloudinary(videoFile, progressCallback, 'video'); // [DIUBAH] Tipe 'video'
                const baseUrl = uploadResult.secure_url.replace(/\/v\d+\//, '/');
                const duration = Math.round(uploadResult.duration || 0); 
                
                const videoFiles = {
                    '1080p': baseUrl.replace('/upload/', `/upload/c_scale,h_1080/`),
                    '720p': baseUrl.replace('/upload/', `/upload/c_scale,h_720/`),
                    '480p': baseUrl.replace('/upload/', `/upload/c_scale,h_480/`)
                };

                statusEl.textContent = "Menyimpan episode ke database...";
                const episodeCollRef = collection(db, 'series', seriesId, 'episodes');
                await addDoc(episodeCollRef, {
                    episodeNumber: parseInt(episodeNumber),
                    title: episodeTitle || `Episode ${episodeNumber}`,
                    videoFiles,
                    duration: duration, 
                    publishAt: Timestamp.now()
                });
                
                // Tambahkan hitungan episode di dokumen serial
                const seriesRef = doc(db, 'series', seriesId);
                await updateDoc(seriesRef, {
                    episodeCount: increment(1),
                    updatedAt: Timestamp.now() // [BARU] Perbarui updatedAt
                });

                statusEl.textContent = "Episode berhasil disimpan!";
                setTimeout(() => {
                    document.getElementById('add-episode-modal').classList.add('hidden');
                    document.getElementById('add-episode-form').reset();
                    statusEl.textContent = "";
                }, 2000);

            } catch(error) {
                statusEl.textContent = `Error: ${error.message}`;
            } finally {
                saveBtn.disabled = false;
            }
        }
        
        window.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>

